name: Cross-Platform PAI Test Suite

on:
  pull_request:
    paths:
      - 'Releases/v3.0/.claude/**'
      - '.github/workflows/cross-platform-tests.yml'
  push:
    branches:
      - main
      - 'feature/windows-*'
    paths:
      - 'Releases/v3.0/.claude/**'
      - '.github/workflows/cross-platform-tests.yml'
  workflow_dispatch:

jobs:
  # ─── Core Test Matrix (3 platforms) ──────────────────────────────────────────
  test:
    name: Tests (${{ matrix.os-label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            os-label: Windows
          - os: ubuntu-latest
            os-label: Linux
          - os: macos-latest
            os-label: macOS

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Playwright Chromium
        working-directory: Releases/v3.0/.claude
        run: npx playwright install chromium --with-deps

      - name: Setup virtual audio (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pulseaudio
          pulseaudio --start --daemonize || true
          pactl load-module module-null-sink sink_name=virtual_speaker || true

      - name: Verify environment
        run: |
          bun --version
          node --version
          git --version

      - name: Run platform unit tests
        working-directory: Releases/v3.0/.claude
        run: bun test lib/platform.test.ts lib/terminal.test.ts lib/platform-audit.test.ts --timeout 30000

      - name: Run Windows E2E test suite
        working-directory: Releases/v3.0/.claude
        env:
          ANTHROPIC_API_KEY: "sk-ant-dummy-ci-test-key"
          OPENAI_API_KEY: "sk-dummy-ci-test-key"
          APIFY_TOKEN: "apify_dummy_ci_token"
          PAI_TEST_MODE: "1"
        run: bun test tests/windows/ --timeout 30000

      - name: Run cross-platform test suite
        working-directory: Releases/v3.0/.claude
        env:
          ANTHROPIC_API_KEY: "sk-ant-dummy-ci-test-key"
          OPENAI_API_KEY: "sk-dummy-ci-test-key"
          APIFY_TOKEN: "apify_dummy_ci_token"
          PAI_TEST_MODE: "1"
        run: bun test tests/cross-platform/ --timeout 30000

      - name: Run forbidden pattern audit
        working-directory: Releases/v3.0/.claude
        run: bun test tests/windows/07-forbidden-patterns.test.ts --timeout 60000

  # ─── Windows Install E2E (Windows-only) ──────────────────────────────────────
  windows-install-e2e:
    name: Windows Install E2E
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Verify environment
        run: |
          bun --version
          git --version
          echo "OS: $env:OS"
          echo "Platform: win32"
          echo "Home: $env:USERPROFILE"

      - name: Run installer E2E tests
        working-directory: Releases/v3.0/.claude
        run: bun test tests/windows/10-install-e2e.test.ts --timeout 60000

      - name: Test installer detect module directly
        working-directory: Releases/v3.0/.claude
        run: |
          bun -e "
            const { detectSystem } = require('./PAI-Install/engine/detect');
            const d = detectSystem();
            console.log('Platform:', d.os.platform);
            console.log('OS Name:', d.os.name);
            console.log('Shell:', d.shell.name, d.shell.path);
            console.log('Bun:', d.tools.bun.installed, d.tools.bun.version);
            console.log('Git:', d.tools.git.installed, d.tools.git.version);
            console.log('Home:', d.homeDir);
            console.log('PAI Dir:', d.paiDir);
            if (d.os.platform !== 'win32') {
              console.error('FAIL: Expected win32 but got', d.os.platform);
              process.exit(1);
            }
            console.log('PASS: Platform detection correct');
          "

      - name: Test configuration generation
        working-directory: Releases/v3.0/.claude
        run: |
          bun -e "
            const { generateSettingsJson } = require('./PAI-Install/engine/config-gen');
            const os = require('os');
            const path = require('path');
            const config = generateSettingsJson({
              principalName: 'CI-Test',
              timezone: 'UTC',
              aiName: 'TestAI',
              catchphrase: 'Hello CI',
              paiDir: path.join(os.tmpdir(), '.claude-ci-test'),
              configDir: path.join(os.tmpdir(), '.config-ci-test'),
            });
            if (!config.principal || config.principal.name !== 'CI-Test') {
              console.error('FAIL: Config generation incorrect');
              process.exit(1);
            }
            console.log('PASS: Config generation correct');
            console.log('Settings preview:', JSON.stringify(config.principal));
          "

      - name: Test manage.ts CLI help on Windows
        working-directory: Releases/v3.0/.claude
        run: |
          $result = bun run VoiceServer/manage.ts 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "manage.ts exited with code $LASTEXITCODE"
            exit 1
          }
          $output = $result -join "`n"
          if ($output -notmatch 'PAI Voice Server Manager') {
            Write-Error "manage.ts output missing expected header"
            Write-Host "Actual output: $output"
            exit 1
          }
          if ($output -notmatch 'Windows') {
            Write-Error "manage.ts output missing Windows platform name"
            Write-Host "Actual output: $output"
            exit 1
          }
          Write-Host "PASS: manage.ts CLI works on Windows"
          Write-Host $output

      - name: Test directory structure creation on Windows
        run: |
          $testDir = Join-Path $env:TEMP "pai-ci-install-test"
          $dirs = @('MEMORY', 'MEMORY\STATE', 'MEMORY\WORK', 'hooks', 'skills', 'Plans')
          foreach ($dir in $dirs) {
            $fullPath = Join-Path $testDir $dir
            New-Item -ItemType Directory -Path $fullPath -Force | Out-Null
            if (-not (Test-Path $fullPath)) {
              Write-Error "FAIL: Could not create $fullPath"
              exit 1
            }
          }
          $settingsPath = Join-Path $testDir 'settings.json'
          $config = @{ principal = @{ name = 'CI-Test' }; pai = @{ version = '3.0' } } | ConvertTo-Json
          Set-Content -Path $settingsPath -Value $config
          $read = Get-Content $settingsPath | ConvertFrom-Json
          if ($read.principal.name -ne 'CI-Test') {
            Write-Error "FAIL: Settings read-back mismatch"
            exit 1
          }
          Remove-Item -Recurse -Force $testDir
          Write-Host "PASS: Directory structure creation works on Windows"

      - name: Test platform.ts imports on Windows
        working-directory: Releases/v3.0/.claude
        run: |
          bun -e "
            const p = require('./lib/platform');
            console.log('isWindows:', p.isWindows);
            console.log('getPlatformName:', p.getPlatformName());
            console.log('getDefaultShell:', p.getDefaultShell());
            console.log('getHomeDir:', p.getHomeDir());
            console.log('getTempDir:', p.getTempDir());
            console.log('getAudioPlayCommand:', JSON.stringify(p.getAudioPlayCommand('test.mp3')));
            console.log('getNotificationCommand:', JSON.stringify(p.getNotificationCommand('Test', 'Hello')));
            console.log('getServiceManager:', p.getServiceManager());
            if (!p.isWindows) {
              console.error('FAIL: isWindows should be true');
              process.exit(1);
            }
            if (p.getServiceManager() !== 'task-scheduler') {
              console.error('FAIL: service manager should be task-scheduler');
              process.exit(1);
            }
            console.log('PASS: platform.ts imports and functions work on Windows');
          "

  # ─── Claude CLI E2E (full PAI stack test) ────────────────────────────────────
  claude-e2e:
    name: Claude CLI E2E (${{ matrix.os-label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    # Only run when ANTHROPIC_API_KEY secret is available
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            os-label: Linux
          - os: macos-latest
            os-label: macOS
          - os: windows-latest
            os-label: Windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Setup PAI directory structure (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p ~/.claude
          cp -r Releases/v3.0/.claude/* ~/.claude/
          echo "PAI files copied to ~/.claude/"
          ls ~/.claude/

      - name: Setup PAI directory structure (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Path "$env:USERPROFILE\.claude" -Force | Out-Null
          Copy-Item -Path "Releases\v3.0\.claude\*" -Destination "$env:USERPROFILE\.claude\" -Recurse -Force
          Write-Host "PAI files copied to $env:USERPROFILE\.claude\"
          Get-ChildItem "$env:USERPROFILE\.claude\"

      - name: Test Claude CLI — Basic Hello
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Say hello in exactly 5 words" --max-turns 1 --model claude-sonnet-4-6 --output-format json

      - name: Test Claude CLI — Skill Discovery
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "List 3 skills you have available. Just list names." --max-turns 1 --model claude-sonnet-4-6

      - name: Test Claude CLI — Algorithm Format
        if: ${{ secrets.ANTHROPIC_API_KEY != '' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          OUTPUT=$(claude -p "Use first principles to analyze why 1+1=2. Keep it brief." --max-turns 2 --model claude-sonnet-4-6 2>&1)
          echo "$OUTPUT"
          # Verify PAI Algorithm format appears
          if echo "$OUTPUT" | grep -qi "algorithm\|observe\|verify"; then
            echo "PASS: Algorithm format detected in output"
          else
            echo "WARNING: Algorithm format not detected — may need more turns"
          fi
