#!/bin/bash

#
# External Pentest - Active Discovery Script
# Uses BBOT for active subdomain enumeration and service discovery
#
# Usage: ./active-discovery.sh <domain> [additional_domains...]
#
# WARNING: This performs ACTIVE reconnaissance (DNS brute-force, port scanning)
# REQUIRES explicit authorization before running!
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Check for target
if [ -z "$1" ]; then
    echo -e "${RED}[!] Usage: $0 <domain> [additional_domains...]${NC}"
    echo -e "${BLUE}[*] Example: $0 acme.com${NC}"
    exit 1
fi

# Configuration
TARGETS="$@"
TARGET_JOINED=$(echo "$TARGETS" | tr ' ' ',')
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/bbot/active_${TIMESTAMP}"

echo -e "${BLUE}[*] External Pentest - Active Discovery${NC}"
echo -e "${BLUE}[*] Target(s): ${TARGET_JOINED}${NC}"
echo -e "${BLUE}[*] Output: ${OUTPUT_DIR}${NC}"
echo -e "${MAGENTA}[!] Mode: ACTIVE (will directly contact target systems)${NC}\n"

# Authorization check
echo -e "${YELLOW}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${YELLOW}║  AUTHORIZATION CHECK                                         ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This script performs ACTIVE reconnaissance including:       ║${NC}"
echo -e "${YELLOW}║  - DNS brute-force enumeration                               ║${NC}"
echo -e "${YELLOW}║  - Port scanning                                             ║${NC}"
echo -e "${YELLOW}║  - HTTP probing                                              ║${NC}"
echo -e "${YELLOW}║  - Web screenshots                                           ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This WILL generate network traffic to target systems.       ║${NC}"
echo -e "${YELLOW}╚══════════════════════════════════════════════════════════════╝${NC}\n"

read -p "Do you have explicit written authorization to test these targets? (yes/no): " AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "\n${RED}[!] Active scanning requires explicit authorization.${NC}"
    echo -e "${RED}[!] Please obtain written permission before proceeding.${NC}"
    echo -e "${BLUE}[*] You can run passive-recon.sh without authorization.${NC}"
    exit 1
fi

echo -e "\n${GREEN}[+] Authorization confirmed. Proceeding with active discovery...${NC}\n"

# Create output directory
mkdir -p "${OUTPUT_DIR}"

# Check if BBOT is available
if ! command -v bbot &> /dev/null; then
    echo -e "${RED}[!] BBOT not found. Install with: pipx install bbot${NC}"
    exit 1
fi

# Run BBOT active discovery
echo -e "${BLUE}[*] Starting BBOT active discovery...${NC}"
echo -e "${YELLOW}[!] This may take 30-60+ minutes depending on target size...${NC}\n"

bbot -t "${TARGET_JOINED}" \
    -p subdomain-enum \
    -m portscan httpx gowitness \
    -om json,csv \
    -o "${OUTPUT_DIR}" \
    -n "active_discovery" \
    --yes

# Check for results
if [ -f "${OUTPUT_DIR}/active_discovery/output.json" ]; then
    echo -e "\n${GREEN}[+] Active discovery complete!${NC}"

    # Count results
    SUBDOMAIN_COUNT=$(cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="DNS_NAME") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')
    IP_COUNT=$(cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="IP_ADDRESS") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')
    URL_COUNT=$(cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="URL") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')
    PORT_COUNT=$(cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="OPEN_TCP_PORT") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')

    echo -e "${BLUE}[*] Summary:${NC}"
    echo -e "  Subdomains: ${GREEN}${SUBDOMAIN_COUNT}${NC}"
    echo -e "  IP Addresses: ${GREEN}${IP_COUNT}${NC}"
    echo -e "  Live URLs: ${GREEN}${URL_COUNT}${NC}"
    echo -e "  Open Ports: ${GREEN}${PORT_COUNT}${NC}"

    # Extract to target files
    TARGETS_DIR="../targets"
    mkdir -p "${TARGETS_DIR}"

    echo -e "\n${BLUE}[*] Updating target files...${NC}"

    # Update subdomains (merge with passive results)
    cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="DNS_NAME") | .data' 2>/dev/null | sort -u >> "${TARGETS_DIR}/subdomains.txt"
    sort -u "${TARGETS_DIR}/subdomains.txt" -o "${TARGETS_DIR}/subdomains.txt"
    TOTAL_SUBS=$(wc -l < "${TARGETS_DIR}/subdomains.txt" | tr -d ' ')
    echo -e "  Subdomains (total): ${GREEN}${TOTAL_SUBS}${NC}"

    # Update IPs
    cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="IP_ADDRESS") | .data' 2>/dev/null | sort -u >> "${TARGETS_DIR}/ips.txt"
    sort -u "${TARGETS_DIR}/ips.txt" -o "${TARGETS_DIR}/ips.txt"

    # Extract live URLs
    cat "${OUTPUT_DIR}/active_discovery/output.json" | jq -r 'select(.type=="URL") | .data' 2>/dev/null | sort -u > "${TARGETS_DIR}/urls.txt"
    echo -e "  Live URLs → ${TARGETS_DIR}/urls.txt"

    # Copy screenshots
    if [ -d "${OUTPUT_DIR}/active_discovery/gowitness" ]; then
        mkdir -p "../outputs/screenshots"
        cp -r "${OUTPUT_DIR}/active_discovery/gowitness/"* "../outputs/screenshots/" 2>/dev/null || true
        echo -e "  Screenshots → ../outputs/screenshots/"
    fi

    echo -e "\n${GREEN}[+] Results saved to: ${OUTPUT_DIR}${NC}"
else
    echo -e "\n${RED}[!] No results generated. Check BBOT output above for errors.${NC}"
fi

echo -e "\n${GREEN}[+] Next steps:${NC}"
echo -e "  1. Review live URLs in ${TARGETS_DIR}/urls.txt"
echo -e "  2. Check screenshots in outputs/screenshots/"
echo -e "  3. Identify high-value targets (admin panels, APIs, dev environments)"
echo -e "  4. Run port-scan.sh for detailed service enumeration"
echo -e "  5. Run vuln-scan.sh for vulnerability detection"
