#!/bin/bash

#
# External Pentest - Passive Reconnaissance Script
# Uses BBOT for passive OSINT without touching target systems
#
# Usage: ./passive-recon.sh <domain> [additional_domains...]
#
# This is SAFE to run without explicit authorization as it only queries
# third-party databases (cert transparency, DNS databases, etc.)
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check for target
if [ -z "$1" ]; then
    echo -e "${RED}[!] Usage: $0 <domain> [additional_domains...]${NC}"
    echo -e "${BLUE}[*] Example: $0 acme.com acmecorp.com${NC}"
    exit 1
fi

# Configuration
TARGETS="$@"
TARGET_JOINED=$(echo "$TARGETS" | tr ' ' ',')
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/bbot/passive_${TIMESTAMP}"

echo -e "${BLUE}[*] External Pentest - Passive Reconnaissance${NC}"
echo -e "${BLUE}[*] Target(s): ${TARGET_JOINED}${NC}"
echo -e "${BLUE}[*] Output: ${OUTPUT_DIR}${NC}"
echo -e "${GREEN}[+] Mode: PASSIVE ONLY (safe, no direct target contact)${NC}\n"

# Create output directory
mkdir -p "${OUTPUT_DIR}"

# Check if BBOT is available
if ! command -v bbot &> /dev/null; then
    echo -e "${RED}[!] BBOT not found. Install with: pipx install bbot${NC}"
    echo -e "${YELLOW}[!] Or: pip install bbot${NC}"
    exit 1
fi

# Run BBOT passive reconnaissance
echo -e "${BLUE}[*] Starting BBOT passive reconnaissance...${NC}"
echo -e "${YELLOW}[!] This may take 10-30 minutes depending on target size...${NC}\n"

bbot -t "${TARGET_JOINED}" \
    -f safe \
    -rf passive \
    -om json,csv \
    -o "${OUTPUT_DIR}" \
    -n "passive_recon" \
    --yes

# Check for results
if [ -f "${OUTPUT_DIR}/passive_recon/output.json" ]; then
    echo -e "\n${GREEN}[+] Passive reconnaissance complete!${NC}"

    # Count results
    SUBDOMAIN_COUNT=$(cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="DNS_NAME") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')
    IP_COUNT=$(cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="IP_ADDRESS") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')
    EMAIL_COUNT=$(cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="EMAIL_ADDRESS") | .data' 2>/dev/null | sort -u | wc -l | tr -d ' ')

    echo -e "${BLUE}[*] Summary:${NC}"
    echo -e "  Subdomains: ${GREEN}${SUBDOMAIN_COUNT}${NC}"
    echo -e "  IP Addresses: ${GREEN}${IP_COUNT}${NC}"
    echo -e "  Email Addresses: ${GREEN}${EMAIL_COUNT}${NC}"

    # Extract to target files
    TARGETS_DIR="../targets"
    mkdir -p "${TARGETS_DIR}"

    echo -e "\n${BLUE}[*] Extracting targets...${NC}"

    # Extract subdomains
    cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="DNS_NAME") | .data' 2>/dev/null | sort -u > "${TARGETS_DIR}/subdomains.txt"
    echo -e "  Subdomains → ${TARGETS_DIR}/subdomains.txt"

    # Extract IPs
    cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="IP_ADDRESS") | .data' 2>/dev/null | sort -u > "${TARGETS_DIR}/ips.txt"
    echo -e "  IPs → ${TARGETS_DIR}/ips.txt"

    # Extract emails
    cat "${OUTPUT_DIR}/passive_recon/output.json" | jq -r 'select(.type=="EMAIL_ADDRESS") | .data' 2>/dev/null | sort -u > "${TARGETS_DIR}/emails.txt"
    echo -e "  Emails → ${TARGETS_DIR}/emails.txt"

    echo -e "\n${GREEN}[+] Results saved to: ${OUTPUT_DIR}${NC}"
else
    echo -e "\n${RED}[!] No results generated. Check BBOT output above for errors.${NC}"
fi

echo -e "\n${GREEN}[+] Next steps:${NC}"
echo -e "  1. Review discovered subdomains in ${TARGETS_DIR}/subdomains.txt"
echo -e "  2. Identify in-scope vs out-of-scope assets"
echo -e "  3. Update Scope.md with discovered targets"
echo -e "  4. When authorized, run active-discovery.sh"
