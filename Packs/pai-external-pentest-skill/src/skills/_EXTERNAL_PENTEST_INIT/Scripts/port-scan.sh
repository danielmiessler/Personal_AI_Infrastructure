#!/bin/bash

#
# External Pentest - Port Scanning Script
# Uses Nmap for service detection and enumeration
#
# Usage: ./port-scan.sh [target_file]
#        ./port-scan.sh (uses ../targets/ips.txt by default)
#
# WARNING: This performs ACTIVE port scanning
# REQUIRES explicit authorization before running!
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Configuration
TARGET_FILE="${1:-../targets/ips.txt}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/nmap"

echo -e "${BLUE}[*] External Pentest - Port Scanning${NC}"
echo -e "${BLUE}[*] Target file: ${TARGET_FILE}${NC}"
echo -e "${MAGENTA}[!] Mode: ACTIVE (will directly probe target ports)${NC}\n"

# Check target file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo -e "${RED}[!] Target file not found: ${TARGET_FILE}${NC}"
    echo -e "${YELLOW}[*] Run passive-recon.sh and active-discovery.sh first to populate targets.${NC}"
    exit 1
fi

# Count targets
TARGET_COUNT=$(wc -l < "$TARGET_FILE" | tr -d ' ')
echo -e "${BLUE}[*] Targets to scan: ${TARGET_COUNT}${NC}\n"

if [ "$TARGET_COUNT" -eq 0 ]; then
    echo -e "${RED}[!] No targets in file. Run discovery scripts first.${NC}"
    exit 1
fi

# Authorization check
echo -e "${YELLOW}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${YELLOW}║  AUTHORIZATION CHECK                                         ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This script performs ACTIVE port scanning including:        ║${NC}"
echo -e "${YELLOW}║  - TCP port probing                                          ║${NC}"
echo -e "${YELLOW}║  - Service version detection                                 ║${NC}"
echo -e "${YELLOW}║  - Default script scanning                                   ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This will generate significant network traffic.             ║${NC}"
echo -e "${YELLOW}╚══════════════════════════════════════════════════════════════╝${NC}\n"

read -p "Do you have explicit written authorization? (yes/no): " AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "\n${RED}[!] Port scanning requires explicit authorization.${NC}"
    exit 1
fi

# Create output directory
mkdir -p "${OUTPUT_DIR}"

# Check if Nmap is available
if ! command -v nmap &> /dev/null; then
    echo -e "${RED}[!] Nmap not found. Please install nmap.${NC}"
    exit 1
fi

# Scan options based on target count
if [ "$TARGET_COUNT" -gt 50 ]; then
    echo -e "${YELLOW}[!] Large target list (${TARGET_COUNT}). Using faster scan settings.${NC}"
    SCAN_OPTIONS="-sV -sC --top-ports 1000 -T4"
else
    echo -e "${GREEN}[+] Running comprehensive scan with service detection.${NC}"
    SCAN_OPTIONS="-sV -sC -p-"
fi

echo -e "\n${BLUE}[*] Starting Nmap scan...${NC}"
echo -e "${YELLOW}[!] This may take a while depending on target count and network conditions...${NC}\n"

# Run Nmap
sudo nmap $SCAN_OPTIONS \
    -iL "$TARGET_FILE" \
    -oA "${OUTPUT_DIR}/service_scan_${TIMESTAMP}" \
    --open

echo -e "\n${GREEN}[+] Port scan complete!${NC}"
echo -e "${BLUE}[*] Results saved to:${NC}"
echo -e "  - ${OUTPUT_DIR}/service_scan_${TIMESTAMP}.nmap (human readable)"
echo -e "  - ${OUTPUT_DIR}/service_scan_${TIMESTAMP}.xml (XML format)"
echo -e "  - ${OUTPUT_DIR}/service_scan_${TIMESTAMP}.gnmap (greppable)"

# Quick summary
echo -e "\n${BLUE}[*] Quick Summary:${NC}"
grep "open" "${OUTPUT_DIR}/service_scan_${TIMESTAMP}.nmap" 2>/dev/null | head -20 || echo "  No open ports found"

echo -e "\n${GREEN}[+] Next steps:${NC}"
echo -e "  1. Review open ports and services"
echo -e "  2. Identify high-value services (SSH, RDP, databases, admin interfaces)"
echo -e "  3. Run vuln-scan.sh for vulnerability detection"
echo -e "  4. Manual testing on interesting services"
