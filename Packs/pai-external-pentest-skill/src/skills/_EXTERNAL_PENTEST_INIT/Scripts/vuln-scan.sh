#!/bin/bash

#
# External Pentest - Vulnerability Scanning Script
# Uses Nuclei for automated vulnerability detection
#
# Usage: ./vuln-scan.sh [target_file]
#        ./vuln-scan.sh (uses ../targets/urls.txt by default)
#
# WARNING: This performs ACTIVE vulnerability scanning
# REQUIRES explicit authorization before running!
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Configuration
TARGET_FILE="${1:-../targets/urls.txt}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/nuclei"

echo -e "${BLUE}[*] External Pentest - Vulnerability Scanning${NC}"
echo -e "${BLUE}[*] Target file: ${TARGET_FILE}${NC}"
echo -e "${MAGENTA}[!] Mode: ACTIVE (will probe for vulnerabilities)${NC}\n"

# Check target file exists
if [ ! -f "$TARGET_FILE" ]; then
    echo -e "${RED}[!] Target file not found: ${TARGET_FILE}${NC}"
    echo -e "${YELLOW}[*] Run discovery scripts first to populate targets.${NC}"
    echo -e "${YELLOW}[*] Expected: URLs in targets/urls.txt${NC}"
    exit 1
fi

# Count targets
TARGET_COUNT=$(wc -l < "$TARGET_FILE" | tr -d ' ')
echo -e "${BLUE}[*] Targets to scan: ${TARGET_COUNT}${NC}\n"

if [ "$TARGET_COUNT" -eq 0 ]; then
    echo -e "${RED}[!] No targets in file. Run discovery scripts first.${NC}"
    exit 1
fi

# Authorization check
echo -e "${YELLOW}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${YELLOW}║  AUTHORIZATION CHECK                                         ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This script performs ACTIVE vulnerability scanning:         ║${NC}"
echo -e "${YELLOW}║  - CVE detection                                             ║${NC}"
echo -e "${YELLOW}║  - Misconfiguration checks                                   ║${NC}"
echo -e "${YELLOW}║  - Technology-specific vulnerabilities                       ║${NC}"
echo -e "${YELLOW}║  - Exposed files and panels                                  ║${NC}"
echo -e "${YELLOW}║                                                              ║${NC}"
echo -e "${YELLOW}║  This sends potentially malicious payloads to targets.       ║${NC}"
echo -e "${YELLOW}╚══════════════════════════════════════════════════════════════╝${NC}\n"

read -p "Do you have explicit written authorization? (yes/no): " AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "\n${RED}[!] Vulnerability scanning requires explicit authorization.${NC}"
    exit 1
fi

# Create output directory
mkdir -p "${OUTPUT_DIR}"

# Check if Nuclei is available
if ! command -v nuclei &> /dev/null; then
    echo -e "${RED}[!] Nuclei not found. Install with: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest${NC}"
    exit 1
fi

# Update templates
echo -e "${BLUE}[*] Updating Nuclei templates...${NC}"
nuclei -update-templates -silent 2>/dev/null || echo -e "${YELLOW}[!] Template update skipped${NC}"

echo -e "\n${BLUE}[*] Starting Nuclei vulnerability scan...${NC}"
echo -e "${YELLOW}[!] This may take 30-60+ minutes depending on target count...${NC}\n"

# Run Nuclei with common vulnerability templates
nuclei -l "$TARGET_FILE" \
    -t cves/ \
    -t vulnerabilities/ \
    -t exposures/ \
    -t misconfiguration/ \
    -t default-logins/ \
    -t takeovers/ \
    -severity critical,high,medium \
    -o "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" \
    -json -o "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.json" \
    -stats

echo -e "\n${GREEN}[+] Vulnerability scan complete!${NC}"
echo -e "${BLUE}[*] Results saved to:${NC}"
echo -e "  - ${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt (human readable)"
echo -e "  - ${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.json (JSON format)"

# Summary
if [ -f "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" ]; then
    VULN_COUNT=$(wc -l < "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" | tr -d ' ')
    echo -e "\n${BLUE}[*] Findings: ${GREEN}${VULN_COUNT}${NC} potential vulnerabilities"

    if [ "$VULN_COUNT" -gt 0 ]; then
        echo -e "\n${BLUE}[*] Severity Breakdown:${NC}"
        echo -e "  Critical: $(grep -c '\[critical\]' "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" 2>/dev/null || echo "0")"
        echo -e "  High: $(grep -c '\[high\]' "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" 2>/dev/null || echo "0")"
        echo -e "  Medium: $(grep -c '\[medium\]' "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt" 2>/dev/null || echo "0")"

        echo -e "\n${BLUE}[*] Sample Findings:${NC}"
        head -10 "${OUTPUT_DIR}/vuln_scan_${TIMESTAMP}.txt"
    fi
fi

echo -e "\n${GREEN}[+] Next steps:${NC}"
echo -e "  1. Review findings and validate (eliminate false positives)"
echo -e "  2. Document confirmed vulnerabilities in Findings/"
echo -e "  3. Perform manual testing on high-value findings"
echo -e "  4. Develop proof-of-concept for critical findings"
echo -e "  5. Update Findings/README.md with validated issues"
