#!/bin/bash

#
# Internal Pentest - Network Discovery Script
# Comprehensive host discovery, port scanning, and service enumeration
#
# Usage: ./network-discovery.sh <CIDR> [additional_ranges...]
#
# Example: ./network-discovery.sh 10.0.0.0/24 172.16.0.0/16
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check for target
if [ -z "$1" ]; then
    echo -e "${RED}[!] Usage: $0 <CIDR> [additional_ranges...]${NC}"
    echo -e "${BLUE}[*] Example: $0 10.0.0.0/24${NC}"
    echo -e "${BLUE}[*] Example: $0 10.0.0.0/24 172.16.0.0/16${NC}"
    exit 1
fi

# Configuration
RANGES="$@"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/nmap"
NETEXEC_DIR="../outputs/netexec"
TARGETS_DIR="../targets"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - Network Discovery (Phase 1)            ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Ranges: ${RANGES}${NC}"
echo -e "${BLUE}[*] Timestamp: ${TIMESTAMP}${NC}"
echo ""

# Authorization check
echo -e "${YELLOW}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${YELLOW}║  AUTHORIZATION CHECK                                       ║${NC}"
echo -e "${YELLOW}║                                                            ║${NC}"
echo -e "${YELLOW}║  This script performs ACTIVE network scanning including:   ║${NC}"
echo -e "${YELLOW}║  - ICMP ping sweeps                                       ║${NC}"
echo -e "${YELLOW}║  - TCP/UDP port scanning                                  ║${NC}"
echo -e "${YELLOW}║  - Service version detection                              ║${NC}"
echo -e "${YELLOW}║  - SMB enumeration                                        ║${NC}"
echo -e "${YELLOW}║                                                            ║${NC}"
echo -e "${YELLOW}║  This WILL generate significant network traffic.          ║${NC}"
echo -e "${YELLOW}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""

read -p "Do you have explicit written authorization to scan these networks? (yes/no): " AUTHORIZED

if [ "$AUTHORIZED" != "yes" ]; then
    echo -e "\n${RED}[!] Network scanning requires explicit authorization.${NC}"
    echo -e "${RED}[!] Please obtain written permission before proceeding.${NC}"
    exit 1
fi

echo -e "\n${GREEN}[+] Authorization confirmed. Starting network discovery...${NC}\n"

# Create output directories
mkdir -p "$OUTPUT_DIR" "$NETEXEC_DIR" "$TARGETS_DIR"

# Write ranges to file
echo "$RANGES" | tr ' ' '\n' > "$TARGETS_DIR/ranges.txt"
echo -e "${BLUE}[*] Scope written to ${TARGETS_DIR}/ranges.txt${NC}"

# Check tool availability
check_tool() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "${YELLOW}[!] $1 not found - skipping $1 steps${NC}"
        return 1
    fi
    return 0
}

# ============================================================
# STEP 1: Host Discovery (Ping Sweep)
# ============================================================
echo -e "\n${CYAN}━━━ Step 1: Host Discovery ━━━${NC}"

if check_tool nmap; then
    echo -e "${BLUE}[*] Running ping sweep...${NC}"
    for range in $RANGES; do
        nmap -sn "$range" -oA "${OUTPUT_DIR}/pingsweep_${TIMESTAMP}" 2>/dev/null
    done

    # Extract live hosts
    grep "Up" "${OUTPUT_DIR}/pingsweep_${TIMESTAMP}.gnmap" 2>/dev/null | awk '{print $2}' | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n > "$TARGETS_DIR/live-hosts.txt"
    LIVE_COUNT=$(wc -l < "$TARGETS_DIR/live-hosts.txt" | tr -d ' ')
    echo -e "${GREEN}[+] Discovered ${LIVE_COUNT} live hosts → ${TARGETS_DIR}/live-hosts.txt${NC}"
else
    echo -e "${RED}[!] nmap required for host discovery${NC}"
    exit 1
fi

if [ "$LIVE_COUNT" -eq 0 ]; then
    echo -e "${RED}[!] No live hosts found. Check your scope and try TCP discovery:${NC}"
    echo -e "${BLUE}[*] nmap -sn -PS22,80,443,445 [CIDR]${NC}"
    exit 1
fi

# ============================================================
# STEP 2: Port Scanning
# ============================================================
echo -e "\n${CYAN}━━━ Step 2: Port Scanning (Top 1000) ━━━${NC}"

echo -e "${BLUE}[*] Running service scan on ${LIVE_COUNT} hosts...${NC}"
echo -e "${YELLOW}[!] This may take a while for large networks...${NC}"

nmap -sV -sC -iL "$TARGETS_DIR/live-hosts.txt" -oA "${OUTPUT_DIR}/service_scan_${TIMESTAMP}" --open 2>/dev/null

echo -e "${GREEN}[+] Service scan complete → ${OUTPUT_DIR}/service_scan_${TIMESTAMP}.*${NC}"

# ============================================================
# STEP 3: Identify Domain Controllers
# ============================================================
echo -e "\n${CYAN}━━━ Step 3: Domain Controller Identification ━━━${NC}"

echo -e "${BLUE}[*] Scanning for DC ports (88, 389, 636, 53, 3268)...${NC}"
nmap -p 88,389,636,53,3268 -iL "$TARGETS_DIR/live-hosts.txt" -oA "${OUTPUT_DIR}/dc_scan_${TIMESTAMP}" --open 2>/dev/null

# Extract probable DCs (hosts with port 88 AND 389 open)
grep -E "88/open.*389/open|389/open.*88/open" "${OUTPUT_DIR}/dc_scan_${TIMESTAMP}.gnmap" 2>/dev/null | awk '{print $2}' > "$TARGETS_DIR/domain-controllers.txt" 2>/dev/null || true
DC_COUNT=$(wc -l < "$TARGETS_DIR/domain-controllers.txt" 2>/dev/null | tr -d ' ')
echo -e "${GREEN}[+] Found ${DC_COUNT} probable domain controllers → ${TARGETS_DIR}/domain-controllers.txt${NC}"

# ============================================================
# STEP 4: SMB Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 4: SMB Enumeration ━━━${NC}"

if check_tool netexec; then
    echo -e "${BLUE}[*] Enumerating SMB hosts...${NC}"
    netexec smb "$TARGETS_DIR/live-hosts.txt" 2>/dev/null | tee "${NETEXEC_DIR}/smb_enum_${TIMESTAMP}.txt"

    echo -e "\n${BLUE}[*] Checking SMB signing (for relay attacks)...${NC}"
    netexec smb "$TARGETS_DIR/live-hosts.txt" --gen-relay-list "$TARGETS_DIR/smb-no-signing.txt" 2>/dev/null
    RELAY_COUNT=$(wc -l < "$TARGETS_DIR/smb-no-signing.txt" 2>/dev/null | tr -d ' ')
    echo -e "${GREEN}[+] ${RELAY_COUNT} hosts without SMB signing → ${TARGETS_DIR}/smb-no-signing.txt${NC}"

    if [ "$RELAY_COUNT" -gt 0 ]; then
        echo -e "${MAGENTA}[!] SMB signing disabled on ${RELAY_COUNT} hosts - RELAY ATTACKS POSSIBLE${NC}"
    fi

    echo -e "\n${BLUE}[*] Testing null session access...${NC}"
    netexec smb "$TARGETS_DIR/live-hosts.txt" -u '' -p '' --shares 2>/dev/null | tee "${NETEXEC_DIR}/null_shares_${TIMESTAMP}.txt"

    echo -e "\n${BLUE}[*] Testing guest access...${NC}"
    netexec smb "$TARGETS_DIR/live-hosts.txt" -u 'guest' -p '' --shares 2>/dev/null | tee "${NETEXEC_DIR}/guest_shares_${TIMESTAMP}.txt"
fi

# ============================================================
# STEP 5: Additional Service Discovery
# ============================================================
echo -e "\n${CYAN}━━━ Step 5: Additional Services ━━━${NC}"

if check_tool netexec; then
    echo -e "${BLUE}[*] Checking for MSSQL...${NC}"
    netexec mssql "$TARGETS_DIR/live-hosts.txt" 2>/dev/null | tee "${NETEXEC_DIR}/mssql_enum_${TIMESTAMP}.txt"

    echo -e "${BLUE}[*] Checking for WinRM...${NC}"
    netexec winrm "$TARGETS_DIR/live-hosts.txt" 2>/dev/null | tee "${NETEXEC_DIR}/winrm_enum_${TIMESTAMP}.txt"

    echo -e "${BLUE}[*] Checking for RDP...${NC}"
    netexec rdp "$TARGETS_DIR/live-hosts.txt" 2>/dev/null | tee "${NETEXEC_DIR}/rdp_enum_${TIMESTAMP}.txt"
fi

# ============================================================
# SUMMARY
# ============================================================
echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Network Discovery Complete                                ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}Live Hosts:${NC}          ${GREEN}${LIVE_COUNT}${NC}"
echo -e "  ${BLUE}Domain Controllers:${NC}  ${GREEN}${DC_COUNT}${NC}"
echo -e "  ${BLUE}SMB No Signing:${NC}      ${GREEN}${RELAY_COUNT}${NC} (relay targets)"
echo ""
echo -e "  ${BLUE}Scan Output:${NC}         ${OUTPUT_DIR}/service_scan_${TIMESTAMP}.*"
echo -e "  ${BLUE}Live Hosts:${NC}          ${TARGETS_DIR}/live-hosts.txt"
echo -e "  ${BLUE}DCs:${NC}                 ${TARGETS_DIR}/domain-controllers.txt"
echo -e "  ${BLUE}Relay Targets:${NC}       ${TARGETS_DIR}/smb-no-signing.txt"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. Review service scan results for interesting ports"
echo -e "  2. If DCs found, proceed to AD enumeration: ${CYAN}./ad-enum.sh [DC_IP] [DOMAIN] [USER] [PASS]${NC}"
echo -e "  3. If no creds yet, start Responder: ${CYAN}sudo responder -I [INTERFACE] -wrFP -v${NC}"
echo -e "  4. Consider full port scan: ${CYAN}nmap -p- --min-rate 1000 -iL ${TARGETS_DIR}/live-hosts.txt${NC}"
