# Phase 1: Network Discovery & Enumeration

## Purpose
Comprehensive network discovery, host enumeration, and service identification for internal penetration testing.

## When to Use
- Beginning of internal engagement (Phase 1)
- User asks about network scanning or host discovery
- Need to identify live hosts, services, or network topology

---

## Workflow

### Step 1: Host Discovery

```bash
# Ping sweep (fast, ICMP-based)
nmap -sn [CIDR] -oA outputs/nmap/pingsweep_$(date +%Y%m%d_%H%M%S)

# ARP scan (Layer 2, same subnet only - most reliable)
sudo arp-scan -l -I [INTERFACE]

# TCP discovery (if ICMP blocked)
nmap -sn -PS22,80,443,445,3389 [CIDR] -oA outputs/nmap/tcpdiscovery

# Extract live hosts
grep "Up" outputs/nmap/pingsweep*.gnmap | awk '{print $2}' | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n > targets/live-hosts.txt
```

### Step 2: Port Scanning

```bash
# Top 1000 ports with service detection
nmap -sV -sC -iL targets/live-hosts.txt -oA outputs/nmap/service_scan_$(date +%Y%m%d_%H%M%S)

# Full port scan (background - takes time)
nmap -sV -sC -p- --min-rate 1000 -iL targets/live-hosts.txt -oA outputs/nmap/full_scan_$(date +%Y%m%d_%H%M%S)

# Masscan alternative (very fast, less accurate)
sudo masscan -iL targets/ranges.txt -p1-65535 --rate 1000 -oL outputs/nmap/masscan_all.txt

# UDP top 20
sudo nmap -sU --top-ports 20 -iL targets/live-hosts.txt -oA outputs/nmap/udp_scan
```

### Step 3: Service Enumeration

#### SMB (Port 445)
```bash
# Enumerate all SMB hosts with OS detection
netexec smb targets/live-hosts.txt 2>/dev/null | tee outputs/netexec/smb_enum.txt

# Check SMB signing (CRITICAL - needed for relay attacks)
netexec smb targets/live-hosts.txt --gen-relay-list targets/smb-no-signing.txt

# Null session enumeration
netexec smb targets/live-hosts.txt -u '' -p '' --shares 2>/dev/null | tee outputs/netexec/null_shares.txt
netexec smb targets/live-hosts.txt -u 'guest' -p '' --shares 2>/dev/null | tee outputs/netexec/guest_shares.txt

# Enum4linux-ng (comprehensive)
enum4linux-ng -A [TARGET_IP] -oA outputs/netexec/enum4linux
```

#### MSSQL (Port 1433)
```bash
# Discover MSSQL instances
netexec mssql targets/live-hosts.txt 2>/dev/null | tee outputs/netexec/mssql_enum.txt

# Default credential check
netexec mssql targets/live-hosts.txt -u 'sa' -p 'sa' 2>/dev/null
netexec mssql targets/live-hosts.txt -u 'sa' -p '' 2>/dev/null
```

#### WinRM (Port 5985/5986)
```bash
netexec winrm targets/live-hosts.txt 2>/dev/null | tee outputs/netexec/winrm_enum.txt
```

#### RDP (Port 3389)
```bash
netexec rdp targets/live-hosts.txt 2>/dev/null | tee outputs/netexec/rdp_enum.txt

# NLA check
nmap -p 3389 --script rdp-ntlm-info -iL targets/live-hosts.txt
```

#### SNMP (Port 161)
```bash
# Community string brute-force
onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt -i targets/live-hosts.txt | tee outputs/netexec/snmp_enum.txt

# Walk discovered communities
snmpwalk -c public -v2c [TARGET_IP] | tee outputs/netexec/snmpwalk_[IP].txt
```

#### LDAP (Port 389/636)
```bash
# Anonymous bind check
ldapsearch -x -H ldap://[TARGET_IP] -s base namingContexts

# Identify domain controllers
nmap -p 389,636,88,53,3268 [CIDR] -oA outputs/nmap/dc_scan
grep "open" outputs/nmap/dc_scan.gnmap | awk '{print $2}' > targets/domain-controllers.txt
```

### Step 4: Categorize Hosts

```bash
# Separate Windows and Linux hosts (from Nmap OS detection)
nmap -O -iL targets/live-hosts.txt -oA outputs/nmap/os_detection

# Parse results
grep -i "windows" outputs/nmap/os_detection.nmap | grep -oP '\d+\.\d+\.\d+\.\d+' > targets/windows-hosts.txt
grep -i "linux" outputs/nmap/os_detection.nmap | grep -oP '\d+\.\d+\.\d+\.\d+' > targets/linux-hosts.txt
```

### Step 5: Network Topology Mapping

Document in Notes.md:
- VLAN segmentation observed
- Routing between subnets
- Firewall/ACL restrictions encountered
- Network services (DHCP, DNS, NTP servers)
- Management interfaces discovered (iLO, DRAC, CIMC)

---

## Automation

Run the comprehensive script:
```bash
cd Scripts && ./network-discovery.sh [CIDR]
```

This automates Steps 1-4 with timestamped output.

---

## Key Things to Look For

### Immediate Findings
- **SMB signing disabled** → Enables relay attacks (HIGH)
- **Null sessions permitted** → Information disclosure (MEDIUM)
- **SNMP public community** → Network reconnaissance (MEDIUM)
- **Unencrypted services** → FTP, Telnet, HTTP (MEDIUM)
- **Default credentials** → MSSQL sa:sa, SNMP public (HIGH)
- **Legacy protocols** → NTLMv1, SMBv1 (HIGH)

### High-Value Targets to Identify
- Domain controllers (ports 389, 88, 53, 445)
- Certificate authorities (ADCS)
- MSSQL servers (potential for xp_cmdshell)
- Exchange servers (CVE targets)
- File servers (sensitive data)
- Management interfaces (out-of-band access)
- Development/staging servers (weaker security)
- Jump boxes / bastion hosts

---

## Output Analysis

### Parse Nmap for Quick Wins
```bash
# Find web servers
grep -E "80/open|443/open|8080/open|8443/open" outputs/nmap/service_scan.gnmap

# Find database servers
grep -E "1433/open|3306/open|5432/open|1521/open" outputs/nmap/service_scan.gnmap

# Find remote access
grep -E "22/open|3389/open|5985/open" outputs/nmap/service_scan.gnmap

# Count hosts by OS
netexec smb targets/live-hosts.txt 2>/dev/null | awk '{print $NF}' | sort | uniq -c | sort -rn
```

---

## Deliverables

| File | Contents |
|------|----------|
| `targets/live-hosts.txt` | All discovered live hosts |
| `targets/domain-controllers.txt` | Identified DCs |
| `targets/windows-hosts.txt` | Windows systems |
| `targets/linux-hosts.txt` | Linux systems |
| `targets/services.txt` | Notable services |
| `targets/smb-no-signing.txt` | Relay targets (no SMB signing) |
| `outputs/nmap/` | All scan results |
| `outputs/netexec/` | Service enumeration |

---

## Transition to Phase 2

When complete:
1. All live hosts discovered and categorized
2. Services enumerated with versions
3. Domain controllers identified
4. SMB signing status mapped for relay planning
5. Network topology documented

**Next**: Proceed to `Workflows/ADEnumeration.md` (Phase 2)
