# Remote Kali Deployment Workflow

## Purpose
Manage the deploy → execute → retrieve cycle when testing from a remote Kali box accessed via SSH.

## When to Use
- User says they're testing from a remote Kali machine
- Access method is VPN (Tailscale/WireGuard) + SSH
- Claude Code and PAI are NOT installed on the remote box
- Project has already been initialized locally (VAULT.md exists)

---

## Workflow

### Step 1: Pre-flight

Confirm with the user:

1. **VPN is connected** — Tailscale/WireGuard to the target network or lab
2. **SSH access works** — `ssh user@kali-ip` connects without interactive prompts (key-based auth)
3. **Project is initialized locally** — VAULT.md, Scripts/, targets/ exist in current directory

Gather:
- **Remote host**: `user@kali-ip` (e.g., `kali@10.10.14.5`)
- **Project name**: defaults to current directory name

### Step 2: Deploy

Run from the local project's `Scripts/` directory:

```bash
cd Scripts && ./deploy-remote.sh <user@host> [project-name]
```

**What gets deployed**:
- All pentest scripts (initial-discovery, network-discovery, ad-enum, bloodhound-collection, credential-attacks)
- Empty project scaffold (targets/, outputs/ with all subdirectories)
- Scope.md and Commands.md if they exist (reference docs)
- Any populated target files (ranges.txt, etc.) if scope is already known

**What stays local** (Claude context only):
- VAULT.md, Notes.md, Findings/
- Workflow guides (Workflows/*.md)
- SKILL.md

**Deployed to**: `~/pentests/[project-name]/` on the remote box.

### Step 3: Remote Execution

Guide the user through what to run on the remote Kali box.

**Typical order**:
```bash
# SSH in
ssh <user@host>
cd ~/pentests/<project-name>/Scripts

# Phase 0: Situational awareness
./initial-discovery.sh

# Phase 1: Network scanning (use CIDR from initial-discovery)
./network-discovery.sh <CIDR>

# Phase 2: AD enumeration (requires creds)
./ad-enum.sh <DC_IP> <DOMAIN> <USER> <PASS>

# Phase 2b: BloodHound collection
./bloodhound-collection.sh <DC_IP> <DOMAIN> <USER> <PASS>

# Phase 3: Credential attacks (interactive menu)
./credential-attacks.sh <INTERFACE> <DC_IP> <DOMAIN>
```

**Note**: Claude cannot see the remote terminal. Guide based on what the user reports back. Ask for output snippets if needed to advise next steps.

### Step 4: Retrieve Results

Run from the local project's `Scripts/` directory:

```bash
./retrieve-results.sh <user@host> [remote-project-path]
```

**What gets pulled back**:
- `targets/` — discovered hosts, DCs, ranges, user lists, services
- `outputs/` — nmap scans, BloodHound data, NetExec results, captured hashes, ADCS findings

**Safe to run repeatedly** — uses `rsync --update`, only transfers new/changed files.

### Step 5: Local Analysis

After retrieval, Claude can analyze results directly:

- Read `targets/live-hosts.txt` for discovered hosts
- Read `targets/domain-controllers.txt` for DCs
- Parse nmap XML/gnmap in `outputs/nmap/`
- Review NetExec output in `outputs/netexec/`
- Examine captured hashes in `outputs/responder/`
- Guide next-phase decisions based on findings

Update Notes.md and Findings/ locally as analysis progresses.

### Step 6: Re-sync (Iterative)

During a multi-day engagement, repeat Steps 3-5:

1. User SSHes in, runs more scripts or manual commands
2. Run `retrieve-results.sh` again to pull latest
3. Claude analyzes new data, suggests next actions
4. If scripts are updated locally, run `deploy-remote.sh` again to push updates

---

## Troubleshooting

| Issue | Fix |
|-------|-----|
| SSH connection fails | Check VPN is up, verify IP, test with `ping` |
| Permission denied | Ensure SSH key is deployed, or use `ssh-copy-id user@host` |
| Remote path not found | Verify deploy was run, check `ls ~/pentests/` on remote |
| Rsync hangs | Large BloodHound collections — be patient, or use `--progress` |
| Scripts fail on remote | Check tool dependencies: `which nmap netexec` on Kali |

## Tool Dependencies on Remote Kali

| Tool | Required By | Install |
|------|------------|---------|
| nmap | network-discovery | `apt install nmap` |
| netexec | network-discovery, ad-enum, credential-attacks | `pip install netexec` |
| python3 | initial-discovery | Pre-installed on Kali |
| bloodhound-python | bloodhound-collection | `pip install bloodhound` |
| certipy | ad-enum | `pip install certipy-ad` |
| impacket | ad-enum, credential-attacks | `pip install impacket` |
| responder | credential-attacks | `apt install responder` |

**Minimum**: `nmap` + `netexec` + `python3` covers ~80% of functionality.
