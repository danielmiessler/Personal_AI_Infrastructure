#!/bin/bash

#
# Internal Pentest - BloodHound Collection Script
# Collect AD data for BloodHound CE attack path analysis
#
# Usage: ./bloodhound-collection.sh <DC_IP> <DOMAIN> <USERNAME> <PASSWORD>
#
# Example: ./bloodhound-collection.sh 10.0.0.1 corp.local jsmith 'P@ssw0rd!'
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check arguments
if [ "$#" -lt 4 ]; then
    echo -e "${RED}[!] Usage: $0 <DC_IP> <DOMAIN> <USERNAME> <PASSWORD>${NC}"
    echo -e "${BLUE}[*] Example: $0 10.0.0.1 corp.local jsmith 'P@ssw0rd!'${NC}"
    exit 1
fi

DC_IP="$1"
DOMAIN="$2"
USER="$3"
PASS="$4"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/bloodhound"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - BloodHound Collection                  ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] DC: ${DC_IP}${NC}"
echo -e "${BLUE}[*] Domain: ${DOMAIN}${NC}"
echo -e "${BLUE}[*] User: ${USER}${NC}"
echo ""

mkdir -p "$OUTPUT_DIR"

# Try bloodhound-python first (preferred for Linux)
if command -v bloodhound-python &> /dev/null; then
    echo -e "${BLUE}[*] Using bloodhound-python for collection...${NC}"
    echo -e "${YELLOW}[!] Collection type: All (users, groups, computers, sessions, trusts, ACLs)${NC}"
    echo -e "${YELLOW}[!] This may take several minutes for large domains...${NC}"
    echo ""

    bloodhound-python \
        -u "$USER" \
        -p "$PASS" \
        -d "$DOMAIN" \
        -ns "$DC_IP" \
        -c All \
        --zip \
        -o "$OUTPUT_DIR/" 2>&1 | tee "${OUTPUT_DIR}/collection_log_${TIMESTAMP}.txt"

    # Find the generated zip
    LATEST_ZIP=$(ls -t "${OUTPUT_DIR}"/*.zip 2>/dev/null | head -1)

    if [ -n "$LATEST_ZIP" ]; then
        echo -e "\n${GREEN}[+] BloodHound collection complete!${NC}"
        echo -e "${GREEN}[+] Output: ${LATEST_ZIP}${NC}"
        echo -e "${GREEN}[+] File size: $(du -h "$LATEST_ZIP" | awk '{print $1}')${NC}"
    else
        echo -e "\n${YELLOW}[!] No ZIP generated. Check output above for errors.${NC}"
    fi

# Fallback to NetExec BloodHound module
elif command -v netexec &> /dev/null; then
    echo -e "${YELLOW}[!] bloodhound-python not found. Using NetExec module...${NC}"
    echo ""

    netexec ldap "$DC_IP" \
        -u "$USER" \
        -p "$PASS" \
        --bloodhound \
        -ns "$DC_IP" \
        --collection All 2>&1 | tee "${OUTPUT_DIR}/collection_log_${TIMESTAMP}.txt"

    # Move any generated files
    mv /tmp/.neo4j/*.json "$OUTPUT_DIR/" 2>/dev/null || true

    echo -e "\n${GREEN}[+] NetExec BloodHound collection complete.${NC}"
    echo -e "${BLUE}[*] Check ${OUTPUT_DIR}/ for collection files.${NC}"

else
    echo -e "${RED}[!] Neither bloodhound-python nor netexec found.${NC}"
    echo -e "${BLUE}[*] Install bloodhound-python: pip install bloodhound${NC}"
    echo -e "${BLUE}[*] Install netexec: pip install netexec${NC}"
    exit 1
fi

# ============================================================
# POST-COLLECTION
# ============================================================
echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Collection Complete - Import to BloodHound CE             ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. ${CYAN}Import data to BloodHound CE:${NC}"
echo -e "     - Open BloodHound CE web interface"
echo -e "     - Go to File Ingest → Upload"
echo -e "     - Select: ${LATEST_ZIP:-${OUTPUT_DIR}/*.zip}"
echo ""
echo -e "  2. ${CYAN}Priority queries to run:${NC}"
echo -e "     - Shortest Path to Domain Admins (from owned principals)"
echo -e "     - Kerberoastable Users with Admin Privileges"
echo -e "     - Unconstrained Delegation (non-DC computers)"
echo -e "     - Users with DCSync Rights"
echo -e "     - ADCS Attack Paths"
echo ""
echo -e "  3. ${CYAN}Mark owned principals:${NC}"
echo -e "     - Right-click compromised users/computers → Mark as Owned"
echo -e "     - Re-run shortest path queries with owned context"
echo ""
echo -e "  4. ${CYAN}Continue enumeration:${NC}"
echo -e "     - ADCS deep dive: ${CYAN}certipy find -u '${USER}@${DOMAIN}' -p '[PASS]' -dc-ip ${DC_IP} -vulnerable${NC}"
echo -e "     - Credential attacks: ${CYAN}./credential-attacks.sh [INTERFACE] ${DC_IP} ${DOMAIN}${NC}"
