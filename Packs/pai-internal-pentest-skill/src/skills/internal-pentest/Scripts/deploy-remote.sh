#!/bin/bash

#
# Internal Pentest - Deploy to Remote Kali
# Packages pentest scripts + project scaffold and deploys via SCP
#
# Usage: ./deploy-remote.sh <user@host> [project-name]
#
# Example: ./deploy-remote.sh kali@10.10.14.5
# Example: ./deploy-remote.sh kali@10.10.14.5 acme-pentest
#
# Run from your LOCAL project's Scripts/ directory.
# Deploys to ~/pentests/[project-name]/ on the remote box.
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check for target
if [ -z "$1" ]; then
    echo -e "${RED}[!] Usage: $0 <user@host> [project-name]${NC}"
    echo -e "${BLUE}[*] Example: $0 kali@10.10.14.5${NC}"
    echo -e "${BLUE}[*] Example: $0 kali@10.10.14.5 acme-pentest${NC}"
    exit 1
fi

REMOTE_HOST="$1"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_NAME="${2:-$(basename "$PROJECT_DIR")}"
REMOTE_BASE="~/pentests"
REMOTE_PATH="${REMOTE_BASE}/${PROJECT_NAME}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
TARBALL="/tmp/pentest-deploy-${PROJECT_NAME}-${TIMESTAMP}.tar.gz"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - Deploy to Remote Kali                  ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Remote Host:    ${REMOTE_HOST}${NC}"
echo -e "${BLUE}[*] Project Name:   ${PROJECT_NAME}${NC}"
echo -e "${BLUE}[*] Remote Path:    ${REMOTE_PATH}${NC}"
echo -e "${BLUE}[*] Timestamp:      ${TIMESTAMP}${NC}"
echo ""

# ============================================================
# STEP 1: Verify local tools
# ============================================================
echo -e "${CYAN}━━━ Step 1: Pre-flight Checks ━━━${NC}"

check_tool() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "${RED}[!] $1 not found — required for deployment${NC}"
        return 1
    fi
    return 0
}

check_tool scp || exit 1
check_tool ssh || exit 1
check_tool tar || exit 1

echo -e "${GREEN}[+] Local tools verified (scp, ssh, tar)${NC}"

# Verify SSH connectivity
echo -e "${BLUE}[*] Testing SSH connectivity to ${REMOTE_HOST}...${NC}"
if ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_HOST" "echo ok" &>/dev/null; then
    echo -e "${GREEN}[+] SSH connection successful${NC}"
else
    echo -e "${RED}[!] Cannot connect to ${REMOTE_HOST}${NC}"
    echo -e "${YELLOW}[*] Check: VPN connected? SSH key configured? Host reachable?${NC}"
    exit 1
fi

# ============================================================
# STEP 2: Build care package
# ============================================================
echo -e "\n${CYAN}━━━ Step 2: Building Care Package ━━━${NC}"

STAGING_DIR=$(mktemp -d)
PKG_DIR="${STAGING_DIR}/${PROJECT_NAME}"

# Create project scaffold
mkdir -p "${PKG_DIR}/Scripts"
mkdir -p "${PKG_DIR}/targets"
mkdir -p "${PKG_DIR}/outputs/nmap"
mkdir -p "${PKG_DIR}/outputs/bloodhound"
mkdir -p "${PKG_DIR}/outputs/responder"
mkdir -p "${PKG_DIR}/outputs/netexec"
mkdir -p "${PKG_DIR}/outputs/certipy"
mkdir -p "${PKG_DIR}/outputs/impacket"
mkdir -p "${PKG_DIR}/outputs/sliver"
mkdir -p "${PKG_DIR}/outputs/screenshots"
mkdir -p "${PKG_DIR}/outputs/initial-discovery"
mkdir -p "${PKG_DIR}/Findings"

echo -e "${GREEN}[+] Project scaffold created${NC}"

# Copy pentest scripts (exclude deploy/retrieve meta-scripts)
SCRIPT_COUNT=0
for script in "${SCRIPT_DIR}"/*.sh; do
    script_name=$(basename "$script")
    # Skip meta-scripts — they run locally, not on remote
    if [[ "$script_name" == "deploy-remote.sh" || "$script_name" == "retrieve-results.sh" ]]; then
        continue
    fi
    cp "$script" "${PKG_DIR}/Scripts/"
    chmod +x "${PKG_DIR}/Scripts/${script_name}"
    echo -e "  ${BLUE}+${NC} Scripts/${script_name}"
    SCRIPT_COUNT=$((SCRIPT_COUNT + 1))
done
echo -e "${GREEN}[+] ${SCRIPT_COUNT} pentest scripts packaged${NC}"

# Copy reference docs from project if they exist
DOC_COUNT=0
for doc in Scope.md Commands.md; do
    if [[ -f "${PROJECT_DIR}/${doc}" ]]; then
        cp "${PROJECT_DIR}/${doc}" "${PKG_DIR}/"
        echo -e "  ${BLUE}+${NC} ${doc}"
        DOC_COUNT=$((DOC_COUNT + 1))
    fi
done

if [[ "$DOC_COUNT" -gt 0 ]]; then
    echo -e "${GREEN}[+] ${DOC_COUNT} reference doc(s) included${NC}"
fi

# Copy existing target files if they have content (scope already known)
TARGET_COUNT=0
for target_file in "${PROJECT_DIR}/targets"/*.txt; do
    [[ ! -f "$target_file" ]] && continue
    if [[ -s "$target_file" ]]; then
        cp "$target_file" "${PKG_DIR}/targets/"
        echo -e "  ${BLUE}+${NC} targets/$(basename "$target_file")"
        TARGET_COUNT=$((TARGET_COUNT + 1))
    fi
done

if [[ "$TARGET_COUNT" -gt 0 ]]; then
    echo -e "${GREEN}[+] ${TARGET_COUNT} target file(s) with scope data included${NC}"
fi

# Create tarball
tar -czf "$TARBALL" -C "$STAGING_DIR" "$PROJECT_NAME"
TARBALL_SIZE=$(du -h "$TARBALL" | awk '{print $1}')
echo -e "${GREEN}[+] Tarball created: ${TARBALL_SIZE}${NC}"

# Clean up staging
rm -rf "$STAGING_DIR"

# ============================================================
# STEP 3: Deploy to remote
# ============================================================
echo -e "\n${CYAN}━━━ Step 3: Deploying to ${REMOTE_HOST} ━━━${NC}"

echo -e "${BLUE}[*] Uploading tarball...${NC}"
scp -q "$TARBALL" "${REMOTE_HOST}:/tmp/"
echo -e "${GREEN}[+] Tarball uploaded to /tmp/${NC}"

REMOTE_TARBALL="/tmp/$(basename "$TARBALL")"

echo -e "${BLUE}[*] Extracting on remote...${NC}"
ssh "$REMOTE_HOST" "mkdir -p ${REMOTE_BASE} && tar -xzf ${REMOTE_TARBALL} -C ${REMOTE_BASE}/ && chmod +x ${REMOTE_PATH}/Scripts/*.sh && rm ${REMOTE_TARBALL}"
echo -e "${GREEN}[+] Extracted to ${REMOTE_PATH}/${NC}"

# Clean up local tarball
rm -f "$TARBALL"

# ============================================================
# STEP 4: Verify deployment
# ============================================================
echo -e "\n${CYAN}━━━ Step 4: Verifying Deployment ━━━${NC}"

REMOTE_SCRIPTS=$(ssh "$REMOTE_HOST" "ls ${REMOTE_PATH}/Scripts/*.sh 2>/dev/null | wc -l" | tr -d ' ')
echo -e "${GREEN}[+] ${REMOTE_SCRIPTS} scripts deployed on remote${NC}"

REMOTE_DIRS=$(ssh "$REMOTE_HOST" "ls -d ${REMOTE_PATH}/outputs/*/ 2>/dev/null | wc -l" | tr -d ' ')
echo -e "${GREEN}[+] ${REMOTE_DIRS} output directories created${NC}"

# ============================================================
# SUMMARY
# ============================================================
echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Deployment Complete                                       ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}Remote Host:${NC}     ${GREEN}${REMOTE_HOST}${NC}"
echo -e "  ${BLUE}Project Path:${NC}    ${GREEN}${REMOTE_PATH}${NC}"
echo -e "  ${BLUE}Scripts:${NC}         ${GREEN}${REMOTE_SCRIPTS}${NC}"
echo -e "  ${BLUE}Package Size:${NC}    ${GREEN}${TARBALL_SIZE}${NC}"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. SSH in:              ${CYAN}ssh ${REMOTE_HOST}${NC}"
echo -e "  2. Go to project:       ${CYAN}cd ${REMOTE_PATH}/Scripts${NC}"
echo -e "  3. Run initial recon:   ${CYAN}./initial-discovery.sh${NC}"
echo -e "  4. Run network scan:    ${CYAN}./network-discovery.sh [CIDR]${NC}"
echo ""
echo -e "  ${BLUE}To retrieve results later:${NC}"
echo -e "  ${CYAN}./retrieve-results.sh ${REMOTE_HOST} ${REMOTE_PATH}${NC}"
echo ""
