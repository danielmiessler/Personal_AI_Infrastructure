#!/bin/bash

#
# Internal Pentest - Passive Sniffing & Traffic Analysis Script
# Phase 0: Launch passive credential capture and traffic analysis tools
#
# Usage: sudo ./passive-sniffing.sh [interface]
#
# If no interface specified, auto-detects from default route.
# Requires root (Responder, tcpdump need raw socket access).
#
# This script is PASSIVE ONLY — zero noise on the wire:
#   - Responder in Analyze mode (-A) — listen only, no poisoning
#   - mitm6 with --no-ra — observe IPv6/DHCPv6, no spoofing
#   - Flamingo — passive credential capture (SSH, FTP, HTTP, SMB)
#   - tcpdump — raw packet capture for baseline analysis
#
# Each tool runs in a named screen/zellij pane. Tools are optional —
# the script launches what's installed and warns about what's missing.
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTPUT_DIR="../outputs/passive-sniffing"
RESPONDER_DIR="../outputs/responder"
SESSION_NAME="pentest-passive"

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - Passive Sniffing (Phase 0)             ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Timestamp: ${TIMESTAMP}${NC}"
echo ""

# ============================================================
# Root check
# ============================================================
if [[ "$EUID" -ne 0 ]]; then
    echo -e "${RED}[!] This script must be run as root (sudo)${NC}"
    echo -e "${YELLOW}[*] Usage: sudo $0 [interface]${NC}"
    exit 1
fi

# ============================================================
# Detect platform
# ============================================================
PLATFORM="unknown"
if [[ "$(uname)" == "Darwin" ]]; then
    PLATFORM="macos"
elif [[ "$(uname)" == "Linux" ]]; then
    PLATFORM="linux"
fi
echo -e "${BLUE}[*] Platform: ${PLATFORM}${NC}"

# ============================================================
# Detect or use provided interface
# ============================================================
IFACE="${1:-}"

if [[ -z "$IFACE" ]]; then
    echo -e "${BLUE}[*] No interface specified, auto-detecting...${NC}"
    if [[ "$PLATFORM" == "linux" ]]; then
        IFACE=$(ip route show default 2>/dev/null | awk '{print $5; exit}')
    elif [[ "$PLATFORM" == "macos" ]]; then
        IFACE=$(netstat -rn 2>/dev/null | grep '^default' | head -1 | awk '{print $NF}')
    fi

    if [[ -z "$IFACE" ]]; then
        echo -e "${RED}[!] Could not auto-detect network interface${NC}"
        echo -e "${YELLOW}[*] Usage: sudo $0 <interface>${NC}"
        echo -e "${YELLOW}[*] List interfaces: ip a (Linux) or ifconfig (macOS)${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}[+] Interface: ${IFACE}${NC}"

# ============================================================
# Detect terminal multiplexer
# ============================================================
MUX=""
if command -v zellij &>/dev/null; then
    MUX="zellij"
elif command -v screen &>/dev/null; then
    MUX="screen"
else
    echo -e "${RED}[!] Neither zellij nor screen found${NC}"
    echo -e "${YELLOW}[*] Install one: apt install screen OR cargo install zellij${NC}"
    exit 1
fi

echo -e "${GREEN}[+] Multiplexer: ${MUX}${NC}"

# ============================================================
# Create output directories
# ============================================================
mkdir -p "$OUTPUT_DIR" "$RESPONDER_DIR"
echo -e "${GREEN}[+] Output directories created${NC}"
echo -e "    ${OUTPUT_DIR}"
echo -e "    ${RESPONDER_DIR}"

# ============================================================
# Tool availability check
# ============================================================
check_tool() {
    if command -v "$1" &>/dev/null; then
        echo -e "${GREEN}[+] Found: $1${NC}"
        return 0
    else
        echo -e "${YELLOW}[!] Not found: $1 — skipping${NC}"
        return 1
    fi
}

echo ""
echo -e "${CYAN}━━━ Tool Availability ━━━${NC}"

HAS_RESPONDER=false
HAS_MITM6=false
HAS_FLAMINGO=false
HAS_TCPDUMP=false

check_tool responder && HAS_RESPONDER=true
check_tool mitm6 && HAS_MITM6=true
check_tool flamingo && HAS_FLAMINGO=true
check_tool tcpdump && HAS_TCPDUMP=true

TOOL_COUNT=0
$HAS_RESPONDER && TOOL_COUNT=$((TOOL_COUNT + 1))
$HAS_MITM6 && TOOL_COUNT=$((TOOL_COUNT + 1))
$HAS_FLAMINGO && TOOL_COUNT=$((TOOL_COUNT + 1))
$HAS_TCPDUMP && TOOL_COUNT=$((TOOL_COUNT + 1))

if [[ "$TOOL_COUNT" -eq 0 ]]; then
    echo -e "${RED}[!] No passive sniffing tools found. Install at least one:${NC}"
    echo -e "    ${YELLOW}apt install responder${NC}"
    echo -e "    ${YELLOW}pip install mitm6${NC}"
    echo -e "    ${YELLOW}pip install flamingo${NC}"
    echo -e "    ${YELLOW}apt install tcpdump${NC}"
    exit 1
fi

echo -e "${GREEN}[+] ${TOOL_COUNT}/4 tools available${NC}"
echo ""

# ============================================================
# Resolve absolute paths for output dirs (needed inside screen/zellij)
# ============================================================
ABS_OUTPUT_DIR=$(cd "$OUTPUT_DIR" && pwd)
ABS_RESPONDER_DIR=$(cd "$RESPONDER_DIR" && pwd)

# ============================================================
# Launch tools in multiplexer sessions
# ============================================================
LAUNCHED=()

launch_screen() {
    local pane_name="$1"
    local cmd="$2"
    local logfile="$3"

    if [[ ${#LAUNCHED[@]} -eq 0 ]]; then
        # Create the screen session with the first pane
        screen -dmS "$SESSION_NAME" bash -c "$cmd 2>&1 | tee $logfile; exec bash"
        screen -S "$SESSION_NAME" -X title "$pane_name"
    else
        screen -S "$SESSION_NAME" -X screen -t "$pane_name" bash -c "$cmd 2>&1 | tee $logfile; exec bash"
    fi
    LAUNCHED+=("$pane_name")
}

launch_zellij() {
    local pane_name="$1"
    local cmd="$2"
    local logfile="$3"

    if [[ ${#LAUNCHED[@]} -eq 0 ]]; then
        # Create the zellij session with first command
        zellij --session "$SESSION_NAME" action new-tab --name "$pane_name" -- bash -c "$cmd 2>&1 | tee $logfile; exec bash" &
        sleep 2
    else
        zellij --session "$SESSION_NAME" action new-tab --name "$pane_name" -- bash -c "$cmd 2>&1 | tee $logfile; exec bash" &
        sleep 1
    fi
    LAUNCHED+=("$pane_name")
}

launch_tool() {
    local pane_name="$1"
    local cmd="$2"
    local logfile="$3"

    echo -e "${BLUE}[*] Launching ${pane_name}...${NC}"

    if [[ "$MUX" == "screen" ]]; then
        launch_screen "$pane_name" "$cmd" "$logfile"
    elif [[ "$MUX" == "zellij" ]]; then
        launch_zellij "$pane_name" "$cmd" "$logfile"
    fi

    echo -e "${GREEN}[+] ${pane_name} started → ${logfile}${NC}"
}

echo -e "${CYAN}━━━ Launching Passive Tools ━━━${NC}"

# --- Responder (Analyze mode) ---
if $HAS_RESPONDER; then
    RESP_LOG="${ABS_OUTPUT_DIR}/responder_analyze_${TIMESTAMP}.log"
    launch_tool "responder" "responder -I ${IFACE} -A -v" "$RESP_LOG"
fi

# --- mitm6 (passive / no-ra mode) ---
if $HAS_MITM6; then
    MITM6_LOG="${ABS_OUTPUT_DIR}/mitm6_passive_${TIMESTAMP}.log"
    launch_tool "mitm6" "mitm6 -i ${IFACE} --no-ra" "$MITM6_LOG"
fi

# --- Flamingo (passive credential capture) ---
if $HAS_FLAMINGO; then
    FLAMINGO_LOG="${ABS_OUTPUT_DIR}/flamingo_${TIMESTAMP}.log"
    launch_tool "flamingo" "flamingo -i ${IFACE} -o ${ABS_OUTPUT_DIR}/" "$FLAMINGO_LOG"
fi

# --- tcpdump (baseline packet capture) ---
if $HAS_TCPDUMP; then
    PCAP_FILE="${ABS_OUTPUT_DIR}/baseline_${TIMESTAMP}.pcap"
    TCPDUMP_LOG="${ABS_OUTPUT_DIR}/tcpdump_${TIMESTAMP}.log"
    launch_tool "tcpdump" "tcpdump -i ${IFACE} -w ${PCAP_FILE} -s 0" "$TCPDUMP_LOG"
fi

# ============================================================
# Summary
# ============================================================
echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Passive Sniffing Active                                   ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}Session:${NC}     ${GREEN}${SESSION_NAME}${NC}"
echo -e "  ${BLUE}Interface:${NC}   ${GREEN}${IFACE}${NC}"
echo -e "  ${BLUE}Multiplexer:${NC} ${GREEN}${MUX}${NC}"
echo -e "  ${BLUE}Tools:${NC}       ${GREEN}${TOOL_COUNT}/4 running${NC}"
echo ""

echo -e "  ${CYAN}Running tools:${NC}"
for tool in "${LAUNCHED[@]}"; do
    echo -e "    ${GREEN}✓${NC} ${tool}"
done

NOT_RUNNING=()
$HAS_RESPONDER || NOT_RUNNING+=("responder")
$HAS_MITM6 || NOT_RUNNING+=("mitm6")
$HAS_FLAMINGO || NOT_RUNNING+=("flamingo")
$HAS_TCPDUMP || NOT_RUNNING+=("tcpdump")

if [[ ${#NOT_RUNNING[@]} -gt 0 ]]; then
    echo ""
    echo -e "  ${YELLOW}Missing tools:${NC}"
    for tool in "${NOT_RUNNING[@]}"; do
        echo -e "    ${YELLOW}✗${NC} ${tool}"
    done
fi

echo ""
echo -e "  ${BLUE}Output directory:${NC} ${ABS_OUTPUT_DIR}"
echo ""

# Attach/detach instructions
if [[ "$MUX" == "screen" ]]; then
    echo -e "  ${CYAN}Session management:${NC}"
    echo -e "    Attach:  ${GREEN}screen -r ${SESSION_NAME}${NC}"
    echo -e "    Detach:  ${GREEN}Ctrl+A, D${NC} (from inside session)"
    echo -e "    List:    ${GREEN}screen -ls${NC}"
    echo -e "    Kill:    ${GREEN}screen -S ${SESSION_NAME} -X quit${NC}"
elif [[ "$MUX" == "zellij" ]]; then
    echo -e "  ${CYAN}Session management:${NC}"
    echo -e "    Attach:  ${GREEN}zellij attach ${SESSION_NAME}${NC}"
    echo -e "    Detach:  ${GREEN}Ctrl+O, D${NC} (from inside session)"
    echo -e "    List:    ${GREEN}zellij list-sessions${NC}"
    echo -e "    Kill:    ${GREEN}zellij kill-session ${SESSION_NAME}${NC}"
fi

echo ""
echo -e "${GREEN}[+] Passive sniffing is running in the background.${NC}"
echo -e "${GREEN}[+] Continue with initial-discovery.sh in this terminal.${NC}"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. Run initial discovery: ${CYAN}./initial-discovery.sh${NC}"
echo -e "  2. Let passive tools run during business hours"
echo -e "  3. Review captures: ${CYAN}ls -la ${ABS_OUTPUT_DIR}/${NC}"
echo -e "  4. Check Responder logs: ${CYAN}cat ${ABS_OUTPUT_DIR}/responder_analyze_*.log${NC}"
echo ""
