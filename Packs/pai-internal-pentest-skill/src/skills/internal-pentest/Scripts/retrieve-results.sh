#!/bin/bash

#
# Internal Pentest - Retrieve Results from Remote Kali
# Rsyncs targets/ and outputs/ from remote Kali back to local project
#
# Usage: ./retrieve-results.sh <user@host> [remote-project-path]
#
# Example: ./retrieve-results.sh kali@10.10.14.5
# Example: ./retrieve-results.sh kali@10.10.14.5 ~/pentests/acme-pentest
#
# Run from your LOCAL project's Scripts/ directory.
# Default remote path: ~/pentests/[local-project-name]/
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Check for target
if [ -z "$1" ]; then
    echo -e "${RED}[!] Usage: $0 <user@host> [remote-project-path]${NC}"
    echo -e "${BLUE}[*] Example: $0 kali@10.10.14.5${NC}"
    echo -e "${BLUE}[*] Example: $0 kali@10.10.14.5 ~/pentests/acme-pentest${NC}"
    exit 1
fi

REMOTE_HOST="$1"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_NAME="$(basename "$PROJECT_DIR")"
REMOTE_PATH="${2:-~/pentests/${PROJECT_NAME}}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Internal Pentest - Retrieve Results from Remote Kali      ║${NC}"
echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
echo -e "${BLUE}[*] Remote Host:    ${REMOTE_HOST}${NC}"
echo -e "${BLUE}[*] Remote Path:    ${REMOTE_PATH}${NC}"
echo -e "${BLUE}[*] Local Project:  ${PROJECT_DIR}${NC}"
echo -e "${BLUE}[*] Timestamp:      ${TIMESTAMP}${NC}"
echo ""

# ============================================================
# STEP 1: Pre-flight checks
# ============================================================
echo -e "${CYAN}━━━ Step 1: Pre-flight Checks ━━━${NC}"

check_tool() {
    if ! command -v "$1" &> /dev/null; then
        echo -e "${RED}[!] $1 not found — required for retrieval${NC}"
        return 1
    fi
    return 0
}

check_tool rsync || exit 1
check_tool ssh || exit 1

echo -e "${GREEN}[+] Local tools verified (rsync, ssh)${NC}"

# Verify SSH connectivity
echo -e "${BLUE}[*] Testing SSH connectivity to ${REMOTE_HOST}...${NC}"
if ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_HOST" "echo ok" &>/dev/null; then
    echo -e "${GREEN}[+] SSH connection successful${NC}"
else
    echo -e "${RED}[!] Cannot connect to ${REMOTE_HOST}${NC}"
    echo -e "${YELLOW}[*] Check: VPN connected? SSH key configured? Host reachable?${NC}"
    exit 1
fi

# Verify remote project exists
echo -e "${BLUE}[*] Checking remote project at ${REMOTE_PATH}...${NC}"
if ssh "$REMOTE_HOST" "test -d ${REMOTE_PATH}" &>/dev/null; then
    echo -e "${GREEN}[+] Remote project found${NC}"
else
    echo -e "${RED}[!] Remote project not found at ${REMOTE_PATH}${NC}"
    echo -e "${YELLOW}[*] Did you run deploy-remote.sh first?${NC}"
    echo -e "${YELLOW}[*] Or specify the correct path: $0 ${REMOTE_HOST} /path/to/project${NC}"
    exit 1
fi

# ============================================================
# STEP 2: Snapshot what we have locally before sync
# ============================================================
echo -e "\n${CYAN}━━━ Step 2: Pre-sync Snapshot ━━━${NC}"

# Ensure local dirs exist
mkdir -p "${PROJECT_DIR}/targets" "${PROJECT_DIR}/outputs"

# Count existing local files
LOCAL_TARGETS_BEFORE=$(find "${PROJECT_DIR}/targets" -type f 2>/dev/null | wc -l | tr -d ' ')
LOCAL_OUTPUTS_BEFORE=$(find "${PROJECT_DIR}/outputs" -type f 2>/dev/null | wc -l | tr -d ' ')
echo -e "${BLUE}[*] Local state: ${LOCAL_TARGETS_BEFORE} target files, ${LOCAL_OUTPUTS_BEFORE} output files${NC}"

# ============================================================
# STEP 3: Rsync targets/
# ============================================================
echo -e "\n${CYAN}━━━ Step 3: Syncing targets/ ━━━${NC}"

echo -e "${BLUE}[*] Pulling targets/ from remote...${NC}"
TARGETS_OUTPUT=$(rsync -avz --update --stats "${REMOTE_HOST}:${REMOTE_PATH}/targets/" "${PROJECT_DIR}/targets/" 2>&1)
TARGETS_TRANSFERRED=$(echo "$TARGETS_OUTPUT" | grep "Number of regular files transferred" | awk '{print $NF}')
echo -e "${GREEN}[+] targets/ synced (${TARGETS_TRANSFERRED:-0} files transferred)${NC}"

# Show what's in targets now
echo -e "${BLUE}[*] Target files:${NC}"
for f in "${PROJECT_DIR}/targets"/*.txt; do
    [[ ! -f "$f" ]] && continue
    LINE_COUNT=$(wc -l < "$f" | tr -d ' ')
    if [[ "$LINE_COUNT" -gt 0 ]]; then
        echo -e "  ${GREEN}+${NC} $(basename "$f") (${LINE_COUNT} entries)"
    fi
done

# ============================================================
# STEP 4: Rsync outputs/
# ============================================================
echo -e "\n${CYAN}━━━ Step 4: Syncing outputs/ ━━━${NC}"

echo -e "${BLUE}[*] Pulling outputs/ from remote...${NC}"
OUTPUTS_RESULT=$(rsync -avz --update --stats "${REMOTE_HOST}:${REMOTE_PATH}/outputs/" "${PROJECT_DIR}/outputs/" 2>&1)
OUTPUTS_TRANSFERRED=$(echo "$OUTPUTS_RESULT" | grep "Number of regular files transferred" | awk '{print $NF}')
OUTPUTS_SIZE=$(echo "$OUTPUTS_RESULT" | grep "Total transferred file size" | awk '{print $5, $6}')
echo -e "${GREEN}[+] outputs/ synced (${OUTPUTS_TRANSFERRED:-0} files, ${OUTPUTS_SIZE:-0 bytes})${NC}"

# Show which output dirs have data
echo -e "${BLUE}[*] Output directories with data:${NC}"
for d in "${PROJECT_DIR}/outputs"/*/; do
    [[ ! -d "$d" ]] && continue
    FILE_COUNT=$(find "$d" -type f 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$FILE_COUNT" -gt 0 ]]; then
        DIR_SIZE=$(du -sh "$d" 2>/dev/null | awk '{print $1}')
        echo -e "  ${GREEN}+${NC} $(basename "$d")/ (${FILE_COUNT} files, ${DIR_SIZE})"
    fi
done

# ============================================================
# STEP 5: Post-sync summary
# ============================================================
echo -e "\n${CYAN}━━━ Step 5: Syncing reference docs ━━━${NC}"

# Also pull back any updated Scope.md or Commands.md
DOC_COUNT=0
for doc in Scope.md Commands.md; do
    if ssh "$REMOTE_HOST" "test -f ${REMOTE_PATH}/${doc}" &>/dev/null; then
        rsync -avz --update "${REMOTE_HOST}:${REMOTE_PATH}/${doc}" "${PROJECT_DIR}/${doc}" &>/dev/null
        DOC_COUNT=$((DOC_COUNT + 1))
    fi
done
if [[ "$DOC_COUNT" -gt 0 ]]; then
    echo -e "${GREEN}[+] ${DOC_COUNT} reference doc(s) synced${NC}"
else
    echo -e "${BLUE}[*] No reference docs to sync${NC}"
fi

# ============================================================
# SUMMARY
# ============================================================
LOCAL_TARGETS_AFTER=$(find "${PROJECT_DIR}/targets" -type f 2>/dev/null | wc -l | tr -d ' ')
LOCAL_OUTPUTS_AFTER=$(find "${PROJECT_DIR}/outputs" -type f 2>/dev/null | wc -l | tr -d ' ')

NEW_TARGETS=$((LOCAL_TARGETS_AFTER - LOCAL_TARGETS_BEFORE))
NEW_OUTPUTS=$((LOCAL_OUTPUTS_AFTER - LOCAL_OUTPUTS_BEFORE))

echo -e "\n${GREEN}╔══════════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Results Retrieved                                         ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "  ${BLUE}Remote:${NC}          ${GREEN}${REMOTE_HOST}:${REMOTE_PATH}${NC}"
echo -e "  ${BLUE}New targets:${NC}     ${GREEN}${NEW_TARGETS} files${NC}"
echo -e "  ${BLUE}New outputs:${NC}     ${GREEN}${NEW_OUTPUTS} files${NC}"
echo -e "  ${BLUE}Total targets:${NC}   ${GREEN}${LOCAL_TARGETS_AFTER} files${NC}"
echo -e "  ${BLUE}Total outputs:${NC}   ${GREEN}${LOCAL_OUTPUTS_AFTER} files${NC}"
echo ""
echo -e "${GREEN}[+] Next Steps:${NC}"
echo -e "  1. Review discovered hosts:     ${CYAN}cat ${PROJECT_DIR}/targets/live-hosts.txt${NC}"
echo -e "  2. Review domain controllers:   ${CYAN}cat ${PROJECT_DIR}/targets/domain-controllers.txt${NC}"
echo -e "  3. Check nmap results:          ${CYAN}ls ${PROJECT_DIR}/outputs/nmap/${NC}"
echo -e "  4. Ask Claude to analyze:       ${CYAN}\"Analyze the scan results in outputs/\"${NC}"
echo ""
echo -e "  ${BLUE}Run again to get latest results:${NC}"
echo -e "  ${CYAN}$0 ${REMOTE_HOST} ${REMOTE_PATH}${NC}"
echo ""
