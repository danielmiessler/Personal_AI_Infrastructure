# Phase 2: Active Directory Enumeration & Attack Paths

## Purpose
Comprehensive Active Directory enumeration, BloodHound collection, ADCS analysis, and attack path identification.

## When to Use
- Phase 2 of internal engagement
- User asks about AD enumeration, BloodHound, or ADCS
- Domain credentials available (provided or captured in Phase 3)
- Need to map attack paths to Domain Admin

---

## Prerequisites

- Domain credentials (user:password or NTLM hash)
- Domain controller IP identified (from Phase 1)
- Domain name known

---

## Workflow

### Step 1: Domain Discovery

```bash
# Verify domain connectivity
netexec smb [DC_IP] -u '[USER]' -p '[PASS]'

# Get domain info
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --get-domain-info

# DNS SRV records
nslookup -type=SRV _ldap._tcp.dc._msdcs.[DOMAIN] [DC_IP]
nslookup -type=SRV _kerberos._tcp.[DOMAIN] [DC_IP]

# Find all DCs
nslookup -type=SRV _ldap._tcp.[DOMAIN] [DC_IP]
```

### Step 2: BloodHound Collection

```bash
# bloodhound-python (recommended from Linux)
bloodhound-python -u '[USER]' -p '[PASS]' -d [DOMAIN] -ns [DC_IP] -c All --zip -o outputs/bloodhound/

# Alternative: NetExec module
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --bloodhound -ns [DC_IP] --collection All -o outputs/bloodhound/

# Import to BloodHound CE
# Upload the .zip file to BloodHound CE web interface
```

#### BloodHound Analysis Queries (Priority Order)

1. **Shortest Path to Domain Admins**
   - From owned users/computers
   - Pre-built query in BloodHound

2. **Kerberoastable Users with Privileges**
   ```cypher
   MATCH (u:User {hasspn:true})-[:MemberOf*1..]->(g:Group)
   WHERE g.objectid ENDS WITH '-512' OR g.name =~ '(?i).*admin.*'
   RETURN u.name, u.serviceprincipalnames
   ```

3. **Unconstrained Delegation**
   ```cypher
   MATCH (c:Computer {unconstraineddelegation:true})
   WHERE NOT c.name STARTS WITH 'DC'
   RETURN c.name
   ```

4. **Users with DCSync Rights**
   ```cypher
   MATCH p=(u)-[:GetChanges|GetChangesAll|GetChangesInFilteredSet*1..]->(d:Domain)
   WHERE NOT u.name STARTS WITH 'DC'
   RETURN p
   ```

5. **Shadow Admins** (Non-obvious DA paths)
   - GenericAll on Domain Admins group
   - WriteDACL on domain object
   - Owns on privileged accounts

6. **Outbound Object Control**
   - From owned principals
   - GenericWrite, WriteDACL, WriteOwner, ForceChangePassword

### Step 3: User & Group Enumeration

```bash
# All domain users
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --users | tee outputs/netexec/domain_users.txt

# Extract usernames for target lists
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --users 2>/dev/null | awk '{print $5}' | grep -v '\[' > targets/domain-users.txt

# Domain Admins
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M groupmembership -o GROUP="Domain Admins"

# Enterprise Admins
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M groupmembership -o GROUP="Enterprise Admins"

# All groups
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --groups | tee outputs/netexec/domain_groups.txt

# Admin count users (tier 0)
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --admin-count | tee outputs/netexec/admin_count.txt
```

### Step 4: Password Policy

```bash
# Domain password policy
netexec smb [DC_IP] -u '[USER]' -p '[PASS]' --pass-pol

# Fine-grained password policies
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M get-fgpp
```

**Document in Notes.md:**
- Minimum password length
- Complexity requirements
- Lockout threshold
- Lockout observation window
- Lockout duration
- Password history

### Step 5: ADCS Enumeration

```bash
# Find CA and all templates
certipy find -u '[USER]@[DOMAIN]' -p '[PASS]' -dc-ip [DC_IP] -stdout | tee outputs/certipy/certipy_find.txt

# Check specifically for vulnerable templates
certipy find -u '[USER]@[DOMAIN]' -p '[PASS]' -dc-ip [DC_IP] -vulnerable -stdout | tee outputs/certipy/certipy_vulnerable.txt

# JSON output for detailed analysis
certipy find -u '[USER]@[DOMAIN]' -p '[PASS]' -dc-ip [DC_IP] -json -output outputs/certipy/
```

#### ADCS Vulnerability Reference

| ESC | Name | Impact | Detection |
|-----|------|--------|-----------|
| **ESC1** | Misconfigured Certificate Templates | Domain compromise | Template allows SAN, enrollee supplies subject |
| **ESC2** | Misconfigured Certificate Templates | Domain compromise | Template has Any Purpose or SubCA EKU |
| **ESC3** | Enrollment Agent Templates | Domain compromise | Template allows enrollment on behalf of others |
| **ESC4** | Vulnerable Certificate Template ACL | Domain compromise | Low-priv user can modify template |
| **ESC5** | Vulnerable PKI AD Object ACL | Domain compromise | Write access to CA or NTAuthCertificates |
| **ESC6** | EDITF_ATTRIBUTESUBJECTALTNAME2 | Domain compromise | CA flag allows SAN in all requests |
| **ESC7** | Vulnerable CA ACL | Domain compromise | ManageCA or ManageCertificates rights |
| **ESC8** | NTLM Relay to ADCS HTTP | Domain compromise | Web enrollment enabled without HTTPS enforcement |
| **ESC9** | No Security Extension | Domain compromise | CT_FLAG_NO_SECURITY_EXTENSION on template |
| **ESC10** | Weak Certificate Mappings | Account takeover | Registry allows weak mapping |
| **ESC11** | IF_ENFORCEENCRYPTICERTREQUEST | Domain compromise | RPC enrollment without encryption |
| **ESC13** | OID Group Link | Privilege escalation | Issuance policy linked to group |

### Step 6: Share Enumeration

```bash
# List all accessible shares
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' --shares | tee outputs/netexec/shares.txt

# Spider shares for sensitive files
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' -M spider_plus -o EXCLUDE_DIR=IPC$ | tee outputs/netexec/spider.txt

# Look for specific sensitive files
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' -M spider_plus -o EXTENSIONS=txt,xml,config,ini,bat,ps1,vbs,kdbx
```

### Step 7: Additional Enumeration

```bash
# Trust relationships
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --trusted-for-delegation

# DNS zone dump
adidnsdump -u '[DOMAIN]\[USER]' -p '[PASS]' [DC_IP] | tee outputs/netexec/dns_dump.txt

# GPO enumeration
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M get-gpo | tee outputs/netexec/gpos.txt

# GPP passwords (cpassword in SYSVOL)
netexec smb [DC_IP] -u '[USER]' -p '[PASS]' -M gpp_password

# LAPS check
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M laps

# Machine Account Quota (for RBCD attacks)
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M maq
```

---

## Automation

Run the comprehensive script:
```bash
cd Scripts && ./ad-enum.sh [DC_IP] [DOMAIN] [USER] [PASS]
```

For BloodHound specifically:
```bash
cd Scripts && ./bloodhound-collection.sh [DC_IP] [DOMAIN] [USER] [PASS]
```

---

## Key Things to Look For

### Critical Findings
- ADCS ESC1-ESC8 vulnerabilities → Direct DA path
- Unconstrained delegation on non-DC computers → Coercion attack
- Users with DCSync rights → Immediate domain compromise
- GPP passwords (cpassword) → Plaintext credentials
- Kerberoastable privileged accounts → Hash cracking
- AS-REP roastable accounts → Hash cracking without auth

### High Findings
- Weak password policy (< 12 chars, no lockout)
- LAPS not deployed → Local admin password reuse
- Machine Account Quota > 0 → RBCD attacks possible
- Excessive admin group membership
- Stale privileged accounts
- Service accounts with user-set passwords

### Medium Findings
- NTLMv1 allowed in domain
- No fine-grained password policies
- Excessive trust relationships
- Unused privileged accounts
- Sensitive data in accessible shares

---

## Deliverables

| File | Contents |
|------|----------|
| `outputs/bloodhound/` | BloodHound collection ZIP |
| `outputs/certipy/` | ADCS analysis |
| `outputs/netexec/domain_users.txt` | User enumeration |
| `outputs/netexec/domain_groups.txt` | Group enumeration |
| `outputs/netexec/shares.txt` | Share enumeration |
| `targets/domain-users.txt` | Username list for spraying |
| Updated Notes.md | Password policy, observations |

---

## Transition to Phase 3

When complete:
1. BloodHound data collected and imported
2. Attack paths to DA identified
3. ADCS vulnerabilities enumerated
4. User list extracted for password spraying
5. Password policy documented (for spray planning)
6. Sensitive data in shares noted

**Next**: Proceed to `Workflows/CredentialAttacks.md` (Phase 3)
